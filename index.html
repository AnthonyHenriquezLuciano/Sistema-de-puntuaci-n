<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Turnos</title>
    <style>
        /* --- Diseño Profesional Renovado --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        :root {
            --color-primary: #00529B; /* Azul primario */
            --color-secondary: #00A3E0; /* Azul claro para acentos */
            --color-background: #F0F4F8; /* Gris claro de fondo */
            --color-surface: #FFFFFF; /* Blanco para tarjetas */
            --color-text-primary: #212529; /* Texto oscuro */
            --color-text-secondary: #6c757d; /* Texto gris */
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: var(--color-primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header h1 svg {
            width: 40px;
            height: 40px;
            fill: var(--color-primary);
        }

        .header p {
            color: var(--color-text-secondary);
            font-size: 1.1em;
        }

        .card {
            background-color: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-welcome { font-size: 1.1em; }
        .user-name { font-weight: 500; color: var(--color-primary); }
        .logout-btn { background-color: var(--color-danger); color: white; border: none; padding: 10px 20px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9em; font-weight: 500; transition: background-color 0.2s ease; }
        .logout-btn:hover { background-color: #c82333; }
        .connection-status { padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 500; }
        .connection-status.connected { background: #d4edda; color: #155724; }
        .connection-status.disconnected { background: #f8d7da; color: #721c24; }

        .queue-panel { display: grid; grid-template-columns: 300px 1fr; gap: 25px; }
        @media (max-width: 900px) { .queue-panel { grid-template-columns: 1fr; } }
        
        .active-user-panel, .queue-table-container { border: 1px solid #dee2e6; border-radius: var(--border-radius); padding: 20px; }
        .active-user-panel h3, .queue-table-container h3 { font-size: 1.5em; margin-bottom: 20px; border-bottom: 2px solid var(--color-primary); padding-bottom: 10px; }
        .active-user-panel { text-align: center; }
        
        /* Estilos del Reloj y Cola */
        .timer-clock { position: relative; width: 150px; height: 150px; margin: 20px auto; }
        .timer-circle { fill: none; stroke: #ddd; stroke-width: 10; }
        .timer-progress { fill: none; stroke: var(--color-primary); stroke-width: 10; stroke-linecap: round; transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 0.5s linear; }
        .timer-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2em; font-weight: bold; color: var(--color-primary); }
        .timer-controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        .timer-btn { background-color: var(--color-primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px; }
        .timer-btn:hover { background-color: #003B6D; }
        .timer-btn:disabled { background: #6c757d; cursor: not-allowed; }

        .queue-table table { width: 100%; border-collapse: collapse; }
        .queue-table th, .queue-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        .queue-table th { background-color: var(--color-primary); color: white; font-weight: 500; }
        .queue-table tr:nth-of-type(even) { background-color: var(--color-background); }
        .queue-table tr.current-user { background-color: #cfe2ff; font-weight: 500; }
        .join-queue-btn { background-color: var(--color-success); color: white; border: none; padding: 12px 24px; border-radius: var(--border-radius); cursor: pointer; font-size: 1.1em; margin-top: 20px; transition: background-color 0.2s ease; display: block; width: 100%; text-align: center; font-weight: 500; }
        .join-queue-btn:hover { background-color: #218838; }
        .leave-queue-btn { background-color: var(--color-danger); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
        .leave-queue-btn:hover { background-color: #c82333; }

        /* Estilos del Login Modal */
        .login-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 2000; justify-content: center; align-items: center; padding: 20px;}
        .login-content { background: var(--color-surface); padding: 40px; border-radius: var(--border-radius); width: 100%; max-width: 450px; box-shadow: var(--shadow); text-align: center; }
        .login-content h2 { margin-bottom: 25px; color: var(--color-primary); font-size: 1.8em; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 20px; border: 1px solid #ced4da; border-radius: var(--border-radius); font-size: 1em; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .login-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(0, 163, 224, 0.2); }
        .login-btn { background-color: var(--color-primary); color: white; border: none; padding: 15px 30px; border-radius: var(--border-radius); font-size: 1.1em; cursor: pointer; transition: background-color 0.2s ease; width: 100%; font-weight: 500; }
        .login-btn:hover { background-color: #003B6D; }
        .login-btn:disabled { background: #6c757d; cursor: not-allowed; }
        .error-message { background: #f8d7da; color: #721c24; padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px; display: none; border: 1px solid #f5c6cb; }
        .warning-message { background: #fff3cd; color: #856404; padding: 12px; border-radius: var(--border-radius); margin-bottom: 20px; display: none; border: 1px solid #ffeaa7; }
        
        /* Estilos de Notificaciones y Spinner */
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; vertical-align: middle;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification { position: fixed; top: 20px; right: 20px; color: white; padding: 15px 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); transform: translateX(400px); opacity: 0; transition: all 0.5s ease; z-index: 1000; }
        .notification.show { transform: translateX(0); opacity: 1; }
        .notification.success { background-color: var(--color-success); }
        .notification.warning { background-color: var(--color-warning); color: #212529; }
        .notification.error { background-color: var(--color-danger); }
    </style>
</head>
<body>

    <div class="login-modal" id="loginModal">
        <div class="login-content">
            <h2>Bienvenido</h2>
            <p class="login-subtitle">Inicia sesión para acceder al sistema de turnos</p>
            <div class="error-message" id="userError"></div>
            <div class="warning-message" id="userWarning"></div>
            <input type="email" class="login-input" id="emailInput" placeholder="Correo electrónico" required>
            <input type="password" class="login-input" id="passwordInput" placeholder="Contraseña" required>
            <button class="login-btn" id="loginButton">
                <span id="loginButtonText">Iniciar Sesión</span>
            </button>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <header class="header">
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                Sistema de Turnos
            </h1>
            <p>Gestión de colas de espera con sesión única</p>
        </header>

        <div class="card user-info">
            <div class="user-welcome">
                Bienvenido/a, <span class="user-name" id="userName">...</span>
                <div class="connection-status connected" id="connectionStatus">🟢 Conectado</div>
            </div>
            <div class="current-time" id="currentTime"></div>
            <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
        </div>

        <div class="queue-panel">
            <div class="active-user-panel">
                <h3>Usuario Activo</h3>
                <div id="activeUserInfo">Nadie activo</div>
                <div class="timer-clock">
                    <svg width="150" height="150" viewBox="0 0 150 150">
                        <circle class="timer-circle" cx="75" cy="75" r="65" />
                        <circle class="timer-progress" id="timerProgress" cx="75" cy="75" r="65" stroke-dasharray="408.4" stroke-dashoffset="408.4" />
                    </svg>
                    <div class="timer-text" id="timerText">15:00</div>
                </div>
                <div id="timerControls" class="timer-controls"></div>
            </div>
            <div class="queue-table-container">
                <h3>Cola de Espera</h3>
                <div class="queue-table">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Usuario</th>
                                <th>Hora de Ingreso</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="queueListBody"></tbody>
                    </table>
                </div>
                <button id="joinQueueBtn" class="join-queue-btn">📝 Unirse a la Cola</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
    // =================================================================================
    // CONFIGURACIÓN E INICIALIZACIÓN
    // =================================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyAs2MmgrO0UmXtlm-HWCw2hcfqYcIg74Qs",
        authDomain: "sistema-turnos-gestores.firebaseapp.com",
        databaseURL: "https://sistema-turnos-gestores-default-rtdb.firebaseio.com",
        projectId: "sistema-turnos-gestores",
        storageBucket: "sistema-turnos-gestores.appspot.com",
        messagingSenderId: "322320112231",
        appId: "1:322320112231:web:dbb93a76a85a8906d2d2c2",
        measurementId: "G-GV4JVLKEFY"
    };

    let currentUser = null, sessionId = null, sessionStartTime = null;
    let heartbeatInterval = null, sessionCheckInterval = null, globalTimerInterval = null, syncInterval = null, pageClockInterval = null;
    let isConnected = false, isLoggingIn = false, hasBeenNotified = false;

    const HEARTBEAT_INTERVAL = 30000;
    const SESSION_CHECK_INTERVAL = 10000;
    const TURN_TIME = 15 * 60;
    const SYNC_INTERVAL_SECONDS = 5;

    let database, auth, activeSessionsRef, connectedRef, queueRef, activeUserRef;
    const QUEUE_PATH = 'queueSystem/queue';
    const ACTIVE_USER_PATH = 'queueSystem/activeUser';

    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        try {
            if (typeof window.firebase === 'undefined') {
                throw new Error('El SDK de Firebase no se ha cargado.');
            }
            firebase.initializeApp(firebaseConfig);
            
            database = firebase.database();
            auth = firebase.auth();
            activeSessionsRef = database.ref('activeSessions');
            connectedRef = database.ref('.info/connected');
            queueRef = database.ref(QUEUE_PATH);
            activeUserRef = database.ref(ACTIVE_USER_PATH);
            
            startPageClock();
            
            setupConnectionListener();
            setupLoginUI();
            requestNotificationPermission();
        } catch (error) {
            console.error('Error al inicializar la aplicación:', error);
            showErrorScreen(`Error al inicializar: ${error.message}`);
        }
    }

    // =================================================================================
    // LÓGICA DE RELOJ DE PÁGINA
    // =================================================================================
    function startPageClock() {
        if (pageClockInterval) clearInterval(pageClockInterval);
        pageClockInterval = setInterval(updateCurrentTime, 1000);
    }

    function stopPageClock() {
        if (pageClockInterval) {
            clearInterval(pageClockInterval);
            pageClockInterval = null;
        }
    }

    function updateCurrentTime() {
        const currentTimeElement = document.getElementById('currentTime');
        if (currentTimeElement) {
            currentTimeElement.textContent = new Date().toLocaleString('es-DO', { dateStyle: 'full', timeStyle: 'medium' });
        }
    }

    // =================================================================================
    // LÓGICA DE SESIÓN (LOGIN, LOGOUT, HEARTBEAT)
    // =================================================================================
    function setupLoginUI() {
        try {
            const loginModal = document.getElementById('loginModal');
            loginModal.style.display = 'flex';
            document.getElementById('loginButton').onclick = handleLoginClick;
            document.getElementById('forgotPasswordLink').onclick = handleForgotPassword;
            document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLoginClick();
            });
        } catch (error) {
            showErrorScreen('Error en la interfaz de login: ' + error.message);
        }
    }

    async function handleLoginClick() {
        if (isLoggingIn) return;
        const email = document.getElementById('emailInput').value.trim();
        const password = document.getElementById('passwordInput').value;
        if (!email || !password) return showError('Ingresa correo y contraseña.');

        const loginButton = document.getElementById('loginButton');
        const loginButtonText = document.getElementById('loginButtonText');
        isLoggingIn = true;
        loginButton.disabled = true;
        loginButtonText.innerHTML = '<span class="loading-spinner"></span> Verificando...';
        showError(null);

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            const sessionRef = activeSessionsRef.child(user.uid);
            const sessionSnapshot = await sessionRef.once('value');
            if (sessionSnapshot.exists()) {
                await auth.signOut();
                throw new Error(`El usuario ${email} ya tiene una sesión activa.`);
            }

            sessionId = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
            await sessionRef.set({
                userId: user.uid,
                email: user.email,
                sessionId: sessionId,
                loginTime: firebase.database.ServerValue.TIMESTAMP,
                lastHeartbeatTime: firebase.database.ServerValue.TIMESTAMP
            });
            await sessionRef.onDisconnect().remove();

            currentUser = user;
            sessionStartTime = Date.now();
            document.getElementById('userName').textContent = currentUser.email;
            document.getElementById('sessionStart').textContent = new Date(sessionStartTime).toLocaleString('es-DO');
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';

            setupQueueSystem();
            setupGlobalTimerListener();
            startHeartbeat();
            startSessionMonitoring();
            showNotification(`👋 ¡Bienvenido/a, ${currentUser.email}!`, 'success');
        } catch (error) {
            showError(error.message);
        } finally {
            isLoggingIn = false;
            loginButton.disabled = false;
            loginButtonText.innerHTML = '🚀 Iniciar Sesión';
        }
    }

    async function logout() {
        if (!currentUser) return;
        try {
            await cleanupQueueOnLogout();
            await activeSessionsRef.child(currentUser.uid).remove();
            await auth.signOut();
            showNotification('Sesión cerrada.', 'success');
        } catch (error) {
            console.error('Error en logout:', error);
        } finally {
            cleanupSessionState();
        }
    }
    
    // =================================================================================
    // LÓGICA DE COLA Y TURNOS (CON AUTOCURACIÓN)
    // =================================================================================
    function setupQueueSystem() {
        document.getElementById('joinQueueBtn').onclick = joinQueue;
        setupQueueListeners();
    }

    async function joinQueue() {
        if (!isConnected || !currentUser) {
            showNotification('No estás conectado o autenticado.', 'error');
            return;
        }
        try {
            await activateNextInQueue(); // Intenta limpiar fantasmas antes de unirse

            const activeUserSnap = await activeUserRef.once('value');
            if (activeUserSnap.exists() && activeUserSnap.val().userId === currentUser.uid) {
                return showNotification('Ya tienes un turno activo.', 'warning');
            }
            const queueSnap = await queueRef.orderByChild('userId').equalTo(currentUser.uid).once('value');
            if (queueSnap.exists()) {
                return showNotification('Ya estás en la cola.', 'warning');
            }
            
            const newEntryRef = queueRef.push();
            await newEntryRef.set({
                key: newEntryRef.key,
                userId: currentUser.uid,
                email: currentUser.email,
                joinedAt: firebase.database.ServerValue.TIMESTAMP
            });
            showNotification('Te uniste a la cola.', 'success');
            await activateNextInQueue(); // Intenta activar de nuevo por si el puesto se acaba de desocupar
        } catch (error) {
            showNotification(`Error al unirse a la cola: ${error.message}`, 'error');
        }
    }

    async function leaveQueue(queueKey) {
        try {
            await queueRef.child(queueKey).remove();
            showNotification('Has salido de la cola.', 'success');
        } catch (error) {
            showNotification(`Error al salir de la cola: ${error.message}`, 'error');
        }
    }
    
    /**
     * FUNCIÓN CORREGIDA Y ROBUSTA
     * Esta función ahora maneja la limpieza de usuarios "fantasma" antes de
     * intentar activar al siguiente, solucionando el error.
     */
    async function activateNextInQueue() {
        try {
            // FASE 1: Limpieza del Usuario Activo (si es un fantasma)
            const activeUserSnap = await activeUserRef.once('value');
            if (activeUserSnap.exists()) {
                const activeUser = activeUserSnap.val();
                const sessionSnap = await activeSessionsRef.child(activeUser.userId).once('value');
                // Si el usuario activo NO tiene una sesión, es un fantasma.
                if (!sessionSnap.exists()) {
                    console.log(`Limpiando usuario activo fantasma: ${activeUser.email}`);
                    await activeUserRef.remove(); // Se elimina y la función continúa.
                } else {
                    // Hay un usuario activo y válido, no se hace nada más.
                    return;
                }
            }

            // FASE 2: Buscar y Activar al Siguiente Usuario Válido en la Cola
            const queueSnap = await queueRef.orderByChild('joinedAt').once('value');
            if (!queueSnap.exists()) {
                return; // La cola está vacía.
            }

            const queueData = queueSnap.val();
            // Iteramos sobre la cola para encontrar el primer usuario VÁLIDO
            for (const key in queueData) {
                const userInQueue = queueData[key];
                const sessionSnap = await activeSessionsRef.child(userInQueue.userId).once('value');

                if (sessionSnap.exists()) {
                    // Este es el primer usuario en la cola que tiene una sesión válida. ¡Lo activamos!
                    console.log(`Activando al usuario: ${userInQueue.email}`);
                    await activeUserRef.set({
                        userId: userInQueue.userId,
                        email: userInQueue.email,
                        startTime: firebase.database.ServerValue.TIMESTAMP,
                        remainingTime: TURN_TIME,
                        isPaused: false
                    });
                    await queueRef.child(key).remove(); // Lo sacamos de la cola.
                    return; // Terminamos la función.
                } else {
                    // Este usuario en la cola es un fantasma, lo limpiamos y continuamos el bucle.
                    console.log(`Limpiando usuario fantasma de la cola: ${userInQueue.email}`);
                    await queueRef.child(key).remove();
                }
            }
        } catch (error) {
            console.error('Error en activateNextInQueue:', error);
        }
    }
    
    async function cleanupQueueOnLogout() {
        if (!currentUser) return;
        try {
            const queueSnap = await queueRef.orderByChild('userId').equalTo(currentUser.uid).once('value');
            if (queueSnap.exists()) {
                const updates = {};
                queueSnap.forEach(child => { updates[child.key] = null; });
                await queueRef.update(updates);
            }
            const activeUserSnap = await activeUserRef.once('value');
            if (activeUserSnap.exists() && activeUserSnap.val().userId === currentUser.uid) {
                await activeUserRef.remove();
                await activateNextInQueue();
            }
        } catch (error) { console.error('Error limpiando cola:', error); }
    }
    
    // =================================================================================
    // TEMPORIZADOR DE TURNO SINCRONIZADO
    // =================================================================================
    function setupQueueListeners() {
        try {
            activeUserRef.on('value', (snap) => {
                const data = snap.val();
                renderActiveUser(data);
                if (data && data.userId === currentUser?.uid && !hasBeenNotified) {
                    showNotification('¡Es tu turno!', 'success');
                    showSystemNotification('¡Es tu turno! Regresa al sistema.');
                    hasBeenNotified = true;
                } else if (!data || data.userId !== currentUser?.uid) {
                    hasBeenNotified = false;
                }
            });
            queueRef.on('value', (snap) => {
                renderQueue(snap.val());
            });
        } catch (error) { console.error('Error configurando listeners:', error); }
    }

    function setupGlobalTimerListener() {
        activeUserRef.on('value', (snap) => {
            stopAllTimers();
            const data = snap.val();
            if (!data) {
                updateTimerDisplayUI(TURN_TIME);
                renderActiveUser(null);
                return;
            }
            updateTimerDisplayUI(data.remainingTime || TURN_TIME);
            if (!data.isPaused) {
                startClientTimer(data);
                if (data.userId === currentUser?.uid) {
                    startAuthoritativeSync(data.remainingTime || TURN_TIME);
                }
            }
        });
    }

    function startClientTimer(activeUserData) {
        let remaining = activeUserData.remainingTime || TURN_TIME;
        updateTimerDisplayUI(remaining);
        globalTimerInterval = setInterval(() => {
            remaining--;
            // La lógica de finalizar el turno ya no está aquí para evitar conflictos.
            // El authoritative sync se encarga de eso.
            if (remaining < 0) {
                stopAllTimers();
            } else {
                updateTimerDisplayUI(remaining);
            }
        }, 1000);
    }

    function startAuthoritativeSync(initialTime) {
        let remaining = initialTime || TURN_TIME;
        syncInterval = setInterval(async () => {
            try {
                remaining -= SYNC_INTERVAL_SECONDS;
                if (remaining < 0) {
                    stopAllTimers();
                    await activeUserRef.remove();
                    await activateNextInQueue();
                } else {
                    await activeUserRef.update({ remainingTime: remaining });
                }
            } catch (error) {
                console.error('Error en sincronización autoritativa:', error);
                stopAllTimers(); // Detener si hay un error para evitar bucles.
            }
        }, SYNC_INTERVAL_SECONDS * 1000);
    }

    function stopAllTimers() {
        if (globalTimerInterval) clearInterval(globalTimerInterval);
        if (syncInterval) clearInterval(syncInterval);
        globalTimerInterval = null;
        syncInterval = null;
    }

    // --- El resto de funciones (renderizado, utilidades, etc.) permanecen igual ---
    // Las incluyo para que el script esté completo.
    function pauseTimer() { if (currentUser) { try { activeUserRef.update({ isPaused: true }); } catch (error) { console.error('Error en pauseTimer:', error); } } }
    function resumeTimer() { if (currentUser) { try { activeUserRef.update({ isPaused: false }); } catch (error) { console.error('Error en resumeTimer:', error); } } }
    function renderActiveUser(data) { try { const activeUserInfo = document.getElementById('activeUserInfo'); const timerControls = document.getElementById('timerControls'); if (!data) { activeUserInfo.innerHTML = 'Nadie activo'; timerControls.innerHTML = ''; updateTimerDisplayUI(TURN_TIME); return; } activeUserInfo.innerHTML = `<b>${data.email}</b>`; if (data.userId === currentUser?.uid) { timerControls.innerHTML = `<button id="pauseTimerBtn" class="timer-btn" ${data.isPaused ? 'disabled' : ''}><span>⏸️</span> Pausar</button> <button id="resumeTimerBtn" class="timer-btn" ${!data.isPaused ? 'disabled' : ''}><span>▶️</span> Reanudar</button>`; const pauseBtn = document.getElementById('pauseTimerBtn'); const resumeBtn = document.getElementById('resumeTimerBtn'); if (pauseBtn) pauseBtn.onclick = pauseTimer; if (resumeBtn) resumeBtn.onclick = resumeTimer; } else { timerControls.innerHTML = ''; } } catch (error) { console.error('Error renderizando usuario activo:', error); } }
    function renderQueue(queueData) { try { const queueListBody = document.querySelector('#queueListBody'); queueListBody.innerHTML = ''; if (!queueData) { queueListBody.innerHTML = '<tr><td colspan="5">No hay usuarios en espera</td></tr>'; return; } const sortedQueue = Object.entries(queueData).sort(([, a], [, b]) => a.joinedAt - b.joinedAt); if (sortedQueue.length === 0) { queueListBody.innerHTML = '<tr><td colspan="5">No hay usuarios en espera</td></tr>'; return; } sortedQueue.forEach(([key, q], index) => { const tr = document.createElement('tr'); if (q.userId === currentUser?.uid) tr.classList.add('current-user'); tr.innerHTML = `<td>${index + 1}</td> <td>${q.email}</td> <td>${new Date(q.joinedAt).toLocaleTimeString('es-DO')}</td> <td>En espera</td> <td>${q.userId === currentUser?.uid ? `<button class="leave-queue-btn" onclick="leaveQueue('${q.key}')">🚗 Salir</button>` : ''}</td>`; queueListBody.appendChild(tr); }); } catch (error) { console.error('Error renderizando cola:', error); } }
    function updateTimerDisplayUI(seconds) { try { const timerText = document.getElementById('timerText'); const timerProgress = document.getElementById('timerProgress'); const remaining = Math.max(0, seconds); timerText.textContent = `${Math.floor(remaining / 60).toString().padStart(2, '0')}:${(remaining % 60).toString().padStart(2, '0')}`; timerProgress.style.strokeDashoffset = 408.4 * (1 - (remaining / TURN_TIME)); } catch (error) { console.error('Error actualizando UI del temporizador:', error); } }
    function updateConnectionStatus() { try { const statusElement = document.getElementById('connectionStatus'); statusElement.textContent = isConnected ? '🟢 Conectado' : '🔴 Desconectado'; statusElement.className = `connection-status ${isConnected ? 'connected' : 'disconnected'}`; } catch (error) { console.error('Error actualizando estado de conexión:', error); } }
    function showError(message) { try { const el = document.getElementById('userError'); el.style.display = message ? 'block' : 'none'; el.textContent = message; } catch (error) { console.error('Error mostrando mensaje de error:', error); } }
    function showWarning(message) { try { const el = document.getElementById('userWarning'); el.style.display = message ? 'block' : 'none'; el.textContent = message; } catch (error) { console.error('Error mostrando mensaje de advertencia:', error); } }
    function showNotification(message, type = 'success') { try { const el = document.getElementById('notification'); el.textContent = message; el.className = `notification ${type} show`; setTimeout(() => el.classList.remove('show'), 4000); } catch (error) { console.error('Error mostrando notificación:', error); } }
    function requestNotificationPermission() { try { if ("Notification" in window && Notification.permission !== 'granted') { Notification.requestPermission(); } } catch (error) { console.error('Error solicitando permiso de notificación:', error); } }
    function showSystemNotification(message) { try { if ("Notification" in window && Notification.permission === "granted") { new Notification("Sistema de Turnos", { body: message }); } } catch (error) { console.error('Error mostrando notificación del sistema:', error); } }
    function showErrorScreen(message) { try { stopAllTimers(); stopPageClock(); document.body.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: #f4f4f4; color: #333; text-align: center;"><div style="background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);"><h2>🆘 Error Crítico</h2><p style="margin: 20px 0;">${message}</p><button style="background: #667eea; color: white; padding: 12px 25px; border-radius: 5px; cursor: pointer;" onclick="window.location.reload()">🔄 Recargar</button></div></div>`; } catch (error) { console.error('Error mostrando pantalla de error:', error); } }
    function cleanupSessionState() { try { stopAllTimers(); stopHeartbeat(); stopSessionMonitoring(); if(currentUser)activeSessionsRef.child(currentUser.uid).off(); activeUserRef.off(); queueRef.off(); currentUser=null;sessionId=null;sessionStartTime=null;isLoggingIn=false;hasBeenNotified=false;document.getElementById('mainContainer').style.display='none';document.getElementById('loginModal').style.display='flex';document.getElementById('emailInput').value='';document.getElementById('passwordInput').value='';showError(null);showWarning(null);}catch(error){console.error('Error limpiando estado de sesión:',error);}}
    function setupConnectionListener() { try{connectedRef.on('value',(snap)=>{isConnected=snap.val()===true;updateConnectionStatus();if(!isConnected){showNotification('🔴 Conexión perdida. Intentando reconectar...','warning');}},(error)=>{showNotification('Error en la conexión: '+error.message,'error');});}catch(error){showNotification('Error configurando conexión: '+error.message,'error');}}
    function stopHeartbeat() {if(heartbeatInterval){clearInterval(heartbeatInterval);heartbeatInterval=null;}}
    function stopSessionMonitoring() {if(sessionCheckInterval){clearInterval(sessionCheckInterval);sessionCheckInterval=null;}}
    function startHeartbeat(){if(heartbeatInterval)clearInterval(heartbeatInterval);heartbeatInterval=setInterval(async()=>{if(currentUser&&isConnected){try{await activeSessionsRef.child(currentUser.uid).update({lastHeartbeatTime:firebase.database.ServerValue.TIMESTAMP});}catch(error){console.error('Error en heartbeat:',error);}}},HEARTBEAT_INTERVAL);}
    function startSessionMonitoring(){if(sessionCheckInterval)clearInterval(sessionCheckInterval);sessionCheckInterval=setInterval(async()=>{if(!currentUser||!isConnected)return;try{const sessionSnapshot=await activeSessionsRef.child(currentUser.uid).once('value');if(!sessionSnapshot.exists()||sessionSnapshot.val().sessionId!==sessionId){showNotification('Sesión cerrada desde otro dispositivo.','error');await logout();}}catch(error){console.error('Error en monitoreo de sesión:',error);}},SESSION_CHECK_INTERVAL);}
    function handleForgotPassword(e){e.preventDefault();showWarning('Por favor, contacta al administrador para restablecer tu contraseña.');}

</script>
</body>
</html>
