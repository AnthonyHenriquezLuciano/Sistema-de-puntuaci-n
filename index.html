<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Turnos</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root { 
            --color-primary: #00529B; --color-secondary: #00A3E0; --color-background: #F0F4F8; 
            --color-surface: #FFFFFF; --color-text-primary: #212529; --color-text-secondary: #6c757d; 
            --color-success: #28a745; --color-danger: #dc3545; --color-warning: #ffc107; 
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); --border-radius: 8px; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Roboto', sans-serif; background-color: var(--color-background); 
            color: var(--color-text-primary); min-height: 100vh; padding: 20px; 
            display: flex; align-items: center; justify-content: center; 
        }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { 
            font-size: 2.5em; color: var(--color-primary); font-weight: 700; 
            display: flex; align-items: center; justify-content: center; gap: 15px; 
        }
        .header h1 svg { width: 40px; height: 40px; fill: var(--color-primary); }
        .header p { color: var(--color-text-secondary); font-size: 1.1em; }
        .card { 
            background-color: var(--color-surface); border-radius: var(--border-radius); 
            box-shadow: var(--shadow); padding: 25px; margin-bottom: 20px; 
        }
        .user-info { 
            display: flex; justify-content: space-between; align-items: center; 
            flex-wrap: wrap; gap: 15px; 
        }
        .user-welcome { font-size: 1.1em; }
        .user-name { font-weight: 500; color: var(--color-primary); }
        .logout-btn { 
            background-color: var(--color-danger); color: white; border: none; padding: 10px 20px; 
            border-radius: var(--border-radius); cursor: pointer; font-size: 0.9em; 
            font-weight: 500; transition: background-color 0.2s ease; 
        }
        .logout-btn:hover:not(:disabled) { background-color: #c82333; }
        .logout-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        .connection-status { padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 500; }
        .connection-status.connected { background: #d4edda; color: #155724; }
        .connection-status.disconnected { background: #f8d7da; color: #721c24; }
        .queue-panel { display: grid; grid-template-columns: 300px 1fr; gap: 25px; }
        @media (max-width: 900px) { .queue-panel { grid-template-columns: 1fr; } }
        .active-user-panel, .queue-table-container { 
            border: 1px solid #dee2e6; border-radius: var(--border-radius); padding: 20px; 
        }
        .active-user-panel h3, .queue-table-container h3, .summary-panel h3 { 
            font-size: 1.5em; margin-bottom: 20px; border-bottom: 2px solid var(--color-primary); padding-bottom: 10px; 
        }
        .active-user-panel { text-align: center; }
        .timer-clock { position: relative; width: 150px; height: 150px; margin: 20px auto; }
        .timer-circle { fill: none; stroke: #ddd; stroke-width: 10; }
        .timer-progress { 
            fill: none; stroke: var(--color-primary); stroke-width: 10; stroke-linecap: round; 
            transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 0.5s linear; 
        }
        .timer-text { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 2em; font-weight: bold; color: var(--color-primary); 
        }
        .timer-controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .timer-btn { 
            background-color: var(--color-primary); color: white; border: none; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; 
            display: flex; align-items: center; gap: 8px; 
        }
        .timer-btn:hover:not(:disabled) { background-color: #003B6D; }
        .timer-btn:disabled { background: #6c757d; cursor: not-allowed; }
        .leave-turn-btn { background-color: var(--color-danger); }
        .leave-turn-btn:hover:not(:disabled) { background-color: #c82333; }
        .pause-info { font-size: 0.9em; color: var(--color-text-secondary); margin-top: 10px; }
        .queue-table table { width: 100%; border-collapse: collapse; }
        .queue-table th, .queue-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        .queue-table th { background-color: var(--color-primary); color: white; font-weight: 500; }
        .queue-table tr:nth-of-type(even) { background-color: var(--color-background); }
        .queue-table tr.current-user { background-color: #cfe2ff; font-weight: 500; }
        .join-queue-btn { 
            background-color: var(--color-success); color: white; border: none; padding: 12px 24px; 
            border-radius: var(--border-radius); cursor: pointer; font-size: 1.1em; margin-top: 20px; 
            transition: background-color 0.2s ease; display: block; width: 100%; text-align: center; font-weight: 500; 
        }
        .join-queue-btn:hover:not(:disabled) { background-color: #218838; }
        .join-queue-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        .leave-queue-btn { 
            background-color: var(--color-danger); color: white; border: none; padding: 6px 12px; 
            border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; 
        }
        .leave-queue-btn:hover { background-color: #c82333; }
        .summary-panel { display: none; }
        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; text-align: center; }
        .stat-item { background: var(--color-background); padding: 15px; border-radius: var(--border-radius); }
        .stat-item .label { font-size: 0.9em; color: var(--color-text-secondary); margin-bottom: 5px; display: block; }
        .stat-item .value { font-size: 1.8em; font-weight: 700; color: var(--color-primary); }
        .login-modal { 
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.6); z-index: 2000; justify-content: center; 
            align-items: center; padding: 20px;
        }
        .login-content { 
            background: var(--color-surface); padding: 40px; border-radius: var(--border-radius); 
            width: 100%; max-width: 450px; box-shadow: var(--shadow); text-align: center; 
        }
        .login-content h2 { margin-bottom: 10px; color: var(--color-primary); font-size: 1.8em; }
        .login-subtitle { margin-bottom: 25px; color: var(--color-text-secondary); }
        .login-input { 
            width: 100%; padding: 15px; margin-bottom: 20px; border: 1px solid #ced4da; 
            border-radius: var(--border-radius); font-size: 1em; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease; 
        }
        .login-input:focus { 
            outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(0, 163, 224, 0.2); 
        }
        .login-btn { 
            background-color: var(--color-primary); color: white; border: none; padding: 15px 30px; 
            border-radius: var(--border-radius); font-size: 1.1em; cursor: pointer; 
            transition: background-color 0.2s ease; width: 100%; font-weight: 500; 
        }
        .login-btn:hover { background-color: #003B6D; }
        .login-btn:disabled { background: #6c757d; cursor: not-allowed; }
        .error-message { 
            background: #f8d7da; color: #721c24; padding: 15px; border-radius: var(--border-radius); 
            margin-bottom: 20px; display: none; border: 1px solid #f5c6cb; 
        }
        .forgot-password { font-size: 0.9em; margin-top: 15px; }
        .forgot-password a { color: var(--color-primary); text-decoration: none; }
        .forgot-password a:hover { text-decoration: underline; }
        .loading-spinner { 
            display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); 
            border-top: 2px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; 
            margin-right: 10px; vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification { 
            position: fixed; top: 20px; right: 20px; color: white; padding: 15px 25px; 
            border-radius: var(--border-radius); box-shadow: var(--shadow); 
            transform: translateX(400px); opacity: 0; transition: all 0.5s ease; z-index: 1000; 
        }
        .notification.show { transform: translateX(0); opacity: 1; }
        .notification.success { background-color: var(--color-success); }
        .notification.warning { background-color: var(--color-warning); color: #212529; }
        .notification.error { background-color: var(--color-danger); }
    </style>
</head>
<body>

    <div class="login-modal" id="loginModal">
        <div class="login-content">
            <h2>Bienvenido</h2>
            <p class="login-subtitle">Inicia sesi贸n para acceder al sistema de turnos</p>
            <div class="error-message" id="userError"></div>
            <input type="email" class="login-input" id="emailInput" placeholder="Correo electr贸nico" required>
            <input type="password" class="login-input" id="passwordInput" placeholder="Contrase帽a" required>
            <button class="login-btn" id="loginButton" data-original-text="Iniciar Sesi贸n">
                <span id="loginButtonText">Iniciar Sesi贸n</span>
            </button>
            <p class="forgot-password">
                <a href="#" id="forgotPasswordLink">驴Olvidaste tu contrase帽a?</a>
            </p>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <header class="header">
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                Sistema de Turnos
            </h1>
            <p>Gesti贸n de colas de espera con sesi贸n 煤nica</p>
        </header>
        <div class="card user-info">
            <div class="user-welcome">
                Bienvenido/a, <span class="user-name" id="userName">...</span>
                <div class="connection-status connected" id="connectionStatus"> Conectado</div>
            </div>
            <div class="current-time" id="currentTime"></div>
            <button class="logout-btn" id="logoutBtn" data-original-text="Cerrar Sesi贸n">Cerrar Sesi贸n</button>
        </div>
        <div class="card summary-panel" id="summaryPanel">
            <h3>Tu Resumen de Espera</h3>
            <div class="summary-stats" id="summaryStats"></div>
        </div>
        <div class="card queue-panel">
            <div class="active-user-panel">
                <h3>Usuario Activo</h3>
                <div id="activeUserInfo">Nadie activo</div>
                <div class="timer-clock">
                    <svg width="150" height="150" viewBox="0 0 150 150">
                        <circle class="timer-circle" cx="75" cy="75" r="65" />
                        <circle class="timer-progress" id="timerProgress" cx="75" cy="75" r="65" stroke-dasharray="408.4" stroke-dashoffset="408.4" />
                    </svg>
                    <div class="timer-text" id="timerText">15:00</div>
                </div>
                <div id="timerControls" class="timer-controls"></div>
                <div id="pauseInfo" class="pause-info"></div>
            </div>
            <div class="queue-table-container">
                <h3>Cola de Espera (<span id="queueCount">0</span>)</h3>
                <div class="queue-table">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Usuario</th>
                                <th>Ingreso</th>
                                <th>Acci贸n</th>
                            </tr>
                        </thead>
                        <tbody id="queueListBody"></tbody>
                    </table>
                </div>
                <button id="joinQueueBtn" class="join-queue-btn" data-original-text=" Unirse a la Cola"> Unirse a la Cola</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, get, remove, onDisconnect, serverTimestamp, runTransaction, query, orderByChild, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // --- CONSTANTES Y CONFIGURACIN ---
        const firebaseConfig = {
            apiKey: "AIzaSyAs2MmgrO0UmXtlm-HWCw2hcfqYcIg74Qs",
            authDomain: "sistema-turnos-gestores.firebaseapp.com",
            databaseURL: "https://sistema-turnos-gestores-default-rtdb.firebaseio.com",
            projectId: "sistema-turnos-gestores",
            storageBucket: "sistema-turnos-gestores.appspot.com",
            messagingSenderId: "322320112231",
            appId: "1:322320112231:web:dbb93a76a85a8906d2d2c2",
            measurementId: "G-GV4JVLKEFY"
        };
        
        const TURN_TIME_SECONDS = 15 * 60;
        const MAX_PAUSE_DURATION_SECONDS = 30;
        const MAX_PAUSES_PER_TURN = 2;
        const HEARTBEAT_INTERVAL_MS = 30 * 1000;
        const CLEANUP_INTERVAL_MS = 5 * 60 * 1000;
        const SESSION_TIMEOUT_MS = 10 * 60 * 1000; 

        const MESSAGES = {
            QUEUE_JOIN_SUCCESS: 'Te uniste a la cola.', QUEUE_JOIN_ERROR: 'Error al unirte a la cola.',
            QUEUE_LEAVE_SUCCESS: 'Has salido de la cola.', TURN_NOTIFICATION: '隆Es tu turno!',
            PAUSE_LIMIT_REACHED: 'Has alcanzado el l铆mite de pausas para este turno.',
            PAUSE_TIME_EXPIRED: 'El tiempo de pausa ha terminado. Tu turno se ha reanudado.'
        };
        
        const Logger = {
            error: (context, error, metadata = {}) => console.error(`[${new Date().toISOString()}] CONTEXT: ${context} | ERROR:`, error, "| METADATA:", metadata),
            info: (message, metadata = {}) => console.info(`[${new Date().toISOString()}] INFO: ${message}`, metadata)
        };

        const appState = {
            firebaseApp: null, auth: null, db: null, currentUser: null,
            serverTimeOffset: 0, isConnected: false, wasConnected: true,
            sessionId: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            originalTitle: document.title,
            timers: {}, listeners: [],
            localQueue: [], localActiveUser: null,
        };

        const UIElements = {
            loginModal: document.getElementById('loginModal'), mainContainer: document.getElementById('mainContainer'),
            loginButton: document.getElementById('loginButton'), logoutBtn: document.getElementById('logoutBtn'),
            emailInput: document.getElementById('emailInput'), passwordInput: document.getElementById('passwordInput'),
            userName: document.getElementById('userName'), joinQueueBtn: document.getElementById('joinQueueBtn'),
            queueListBody: document.getElementById('queueListBody'), activeUserInfo: document.getElementById('activeUserInfo'),
            timerText: document.getElementById('timerText'), timerProgress: document.getElementById('timerProgress'),
            timerControls: document.getElementById('timerControls'), pauseInfo: document.getElementById('pauseInfo'),
            summaryPanel: document.getElementById('summaryPanel'), summaryStats: document.getElementById('summaryStats'),
            notification: document.getElementById('notification'), userError: document.getElementById('userError'),
            connectionStatus: document.getElementById('connectionStatus'), currentTime: document.getElementById('currentTime'),
            queueCount: document.getElementById('queueCount'), forgotPasswordLink: document.getElementById('forgotPasswordLink'),
            loginButtonText: document.getElementById('loginButtonText'),
        };

        document.addEventListener('DOMContentLoaded', startApp);
        
        async function startApp() {
            try {
                appState.firebaseApp = initializeApp(firebaseConfig);
                appState.auth = getAuth(appState.firebaseApp);
                appState.db = getDatabase(appState.firebaseApp);
                await setPersistence(appState.auth, browserLocalPersistence);
                addEventListeners();
                startPageClock();
                requestNotificationPermission();
                onValue(ref(appState.db, '.info/serverTimeOffset'), snap => appState.serverTimeOffset = snap.val() || 0);
                onValue(ref(appState.db, '.info/connected'), handleConnectionChange);
                onAuthStateChanged(appState.auth, handleAuthStateChange);
            } catch (error) {
                Logger.error('startApp', error);
                showErrorScreen(`Error Cr铆tico al Inicializar: ${error.message}`);
            }
        }
        
        function addEventListeners() {
            UIElements.loginButton.onclick = handleLogin;
            UIElements.logoutBtn.onclick = handleLogout;
            UIElements.joinQueueBtn.onclick = joinQueue;
            UIElements.forgotPasswordLink.onclick = handleForgotPassword;
            UIElements.passwordInput.onkeypress = e => { if (e.key === 'Enter') handleLogin(); };
            
            UIElements.queueListBody.addEventListener('click', async (e) => {
                if (e.target.matches('.leave-queue-btn')) {
                    const key = e.target.dataset.key;
                    if (!key) return;
                    e.target.disabled = true;
                    try {
                        await remove(ref(appState.db, `queueSystem/queue/${key}`));
                        showQueueMessage('QUEUE_LEAVE_SUCCESS', 'success');
                    } catch (err) { if(handleDatabaseError(err, 'leaveQueueFromList')) return; }
                }
            });
            UIElements.timerControls.addEventListener('click', (e) => {
                const targetButton = e.target.closest('button');
                if (!targetButton) return;
                if (targetButton.id === 'pauseTimerBtn') toggleTimerPause(true);
                if (targetButton.id === 'resumeTimerBtn') toggleTimerPause(false);
                if (targetButton.id === 'leaveTurnBtn') leaveTurn();
            });
        }
        
        function handleConnectionChange(snap) {
            appState.wasConnected = appState.isConnected;
            appState.isConnected = snap.val() === true;
            updateConnectionUI();
            
            if (!appState.wasConnected && appState.isConnected && appState.currentUser) {
                Logger.info('Reconexi贸n detectada. Resincronizando estado.');
                resyncApplicationState();
            }
        }

        function updateConnectionUI() {
            const statusEl = UIElements.connectionStatus;
            statusEl.textContent = appState.isConnected ? ' Conectado' : ' Desconectado';
            statusEl.className = `connection-status ${appState.isConnected ? 'connected' : 'disconnected'}`;
        }

        async function resyncApplicationState() {
            try {
                await setupUserSession(appState.currentUser);
                const queueSnap = await get(query(ref(appState.db, 'queueSystem/queue'), orderByChild('joinedAt')));
                const activeUserSnap = await get(ref(appState.db, 'queueSystem/activeUser'));
                const sortedQueue = [];
                queueSnap.forEach(childSnap => sortedQueue.push(childSnap.val()));
                appState.localQueue = sortedQueue;
                appState.localActiveUser = activeUserSnap.val();
                renderQueue();
                handleActiveUserChange();
            } catch (error) {
                Logger.error('resyncApplicationState', error);
            }
        }

        async function handleAuthStateChange(user) {
            if (user) await onUserLoggedIn(user);
            else onUserLoggedOut();
        }

        const Validator = {
            isEmail: (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email),
            isPasswordStrong: (password) => password.length >= 6
        };
        
        async function handleLogin() {
            setButtonLoading(UIElements.loginButton, true, 'Verificando...');
            const email = UIElements.emailInput.value.trim();
            const password = UIElements.passwordInput.value;

            if (!Validator.isEmail(email)) {
                showError('Por favor, ingresa un correo electr贸nico v谩lido.');
                setButtonLoading(UIElements.loginButton, false, 'Iniciar Sesi贸n');
                return;
            }
            if (!Validator.isPasswordStrong(password)) {
                showError('La contrase帽a debe tener al menos 6 caracteres.');
                setButtonLoading(UIElements.loginButton, false, 'Iniciar Sesi贸n');
                return;
            }

            try {
                await signInWithEmailAndPassword(appState.auth, email, password);
            } catch (error) {
                Logger.error('handleLogin', error, { email });
                showError(getFriendlyAuthError(error.code));
                setButtonLoading(UIElements.loginButton, false, 'Iniciar Sesi贸n');
            }
        }

        async function onUserLoggedIn(user) {
            if (!user || appState.currentUser?.uid === user.uid) return;
            cleanupAll();
            appState.currentUser = user;
            try {
                await setupUserSession(user);
                UIElements.userName.textContent = user.email;
                UIElements.loginModal.style.display = 'none';
                UIElements.mainContainer.style.display = 'block';
                setButtonLoading(UIElements.loginButton, false, 'Iniciar Sesi贸n');
                setupAppListeners();
                appState.timers.cleanup = setInterval(cleanupStaleUsers, CLEANUP_INTERVAL_MS);
            } catch (error) {
                Logger.error('onUserLoggedIn', error, { userId: user.uid });
                if (handleDatabaseError(error, 'onUserLoggedIn')) return;
            }
        }
        
        async function handleLogout() {
            setButtonLoading(UIElements.logoutBtn, true);
            cleanupAll();
            try {
                await signOut(appState.auth);
            } catch (error) {
                Logger.error('handleLogout', error);
                setButtonLoading(UIElements.logoutBtn, false, 'Cerrar Sesi贸n');
            }
        }

        function onUserLoggedOut() {
            cleanupAll();
            appState.currentUser = null;
            UIElements.mainContainer.style.display = 'none';
            UIElements.loginModal.style.display = 'flex';
            UIElements.summaryPanel.style.display = 'none';
            UIElements.emailInput.value = '';
            UIElements.passwordInput.value = '';
            setButtonLoading(UIElements.logoutBtn, false, 'Cerrar Sesi贸n');
            showError(null);
        }
        
        async function setupUserSession(user) {
            const sessionRef = ref(appState.db, `activeSessions/${user.uid}`);
            try {
                await set(sessionRef, { email: user.email, sessionId: appState.sessionId, lastHeartbeat: serverTimestamp() });
                onDisconnect(sessionRef).remove();
                startHeartbeat();
            } catch (error) {
                if (handleDatabaseError(error, 'setupUserSession')) return;
            }
        }

        function setupAppListeners() {
            cleanupAllListeners();
            const activeUserRef = ref(appState.db, 'queueSystem/activeUser');
            const queueRef = query(ref(appState.db, 'queueSystem/queue'), orderByChild('joinedAt'));
            
            const activeUserUnsubscribe = onValue(activeUserRef, (snap) => {
                appState.localActiveUser = snap.val();
                handleActiveUserChange();
            }, (error) => handleDatabaseError(error, 'activeUserListener'));
            
            const queueUnsubscribe = onValue(queueRef, (snap) => {
                const sortedQueue = [];
                snap.forEach(childSnap => sortedQueue.push(childSnap.val()));
                appState.localQueue = sortedQueue;
                renderQueue();
            }, (error) => handleDatabaseError(error, 'queueListener'));

            appState.listeners.push(activeUserUnsubscribe, queueUnsubscribe);
        }

        async function joinQueue() {
            const { currentUser, isConnected } = appState;
            if (!isConnected || !currentUser || UIElements.joinQueueBtn.disabled) return;
            setButtonLoading(UIElements.joinQueueBtn, true, 'Uni茅ndose...');

            if (appState.localActiveUser?.userId === currentUser.uid) {
                showNotification("Ya tienes un turno activo.", "warning");
                setButtonLoading(UIElements.joinQueueBtn, false, ' Unirse a la Cola');
                return;
            }

            try {
                await set(ref(appState.db, `queueSystem/queue/${currentUser.uid}`), { 
                    userId: currentUser.uid, email: currentUser.email, joinedAt: serverTimestamp() 
                });
                showQueueMessage('QUEUE_JOIN_SUCCESS', 'success');
                await promoteNextUserWithRetry();
            } catch (error) {
                showQueueMessage('QUEUE_JOIN_ERROR', 'error');
                if (handleDatabaseError(error, 'joinQueue')) return;
            } finally {
                setButtonLoading(UIElements.joinQueueBtn, false, ' Unirse a la Cola');
            }
        }
        
        async function promoteNextUserWithRetry(maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const activeUserRef = ref(appState.db, 'queueSystem/activeUser');
                    const queueRef = query(ref(appState.db, 'queueSystem/queue'), orderByChild('joinedAt'));
                    const [activeUserSnap, queueSnap, sessionsSnap] = await Promise.all([
                        get(activeUserRef), get(queueRef), get(ref(appState.db, 'activeSessions'))
                    ]);

                    if (activeUserSnap.exists()) return true;
                    if (!queueSnap.exists()) return true;
                    
                    const activeSessions = sessionsSnap.val() || {};
                    let nextInLine = null;
                    queueSnap.forEach(snap => { if(!nextInLine) nextInLine = snap.val() });
                    
                    if (nextInLine && activeSessions[nextInLine.userId]) {
                        const result = await runTransaction(activeUserRef, (currentData) => {
                            if (currentData) return;
                            return {
                                userId: nextInLine.userId, email: nextInLine.email, isPaused: false,
                                remainingTime: TURN_TIME_SECONDS, lastUpdated: serverTimestamp(), pausesUsed: 0
                            };
                        });
                        
                        if (result.committed) {
                            Logger.info(`Usuario ${nextInLine.email} promovido.`);
                            await remove(ref(appState.db, `queueSystem/queue/${nextInLine.userId}`));
                        }
                    } else if (nextInLine) {
                        Logger.info(`El siguiente usuario en cola (${nextInLine.email}) no est谩 conectado. Eliminando de la cola.`);
                        await remove(ref(appState.db, `queueSystem/queue/${nextInLine.userId}`));
                        continue;
                    }
                    return true;
                } catch (error) {
                    Logger.error('promoteUserWithRetry', error, { attempt: i + 1 });
                    if (i === maxRetries - 1) {
                        showError('No se pudo promover al siguiente usuario. Int茅ntalo de nuevo.');
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, 500 * (i + 1)));
                }
            }
            return false;
        }
        
        function handleActiveUserChange() {
            cancelAnimationFrame(appState.timers.activeUserAnimationFrame);
            clearInterval(appState.timers.autoResumeTimer);
            stopTitleNotification();
            renderActiveUserUI();
            updateSummaryPanel();

            const activeUserData = appState.localActiveUser;
            if (activeUserData && !activeUserData.isPaused) {
                startOptimizedTimer(activeUserData);
            } else if (activeUserData && activeUserData.isPaused) {
                 updateTimerDisplayUI(activeUserData.remainingTime);
                 if(activeUserData.userId === appState.currentUser?.uid) {
                    appState.timers.autoResumeTimer = setTimeout(() => {
                        toggleTimerPause(false);
                        showNotification(MESSAGES.PAUSE_TIME_EXPIRED, "warning");
                    }, MAX_PAUSE_DURATION_SECONDS * 1000);
                 }
            } else {
                updateTimerDisplayUI(TURN_TIME_SECONDS);
                if (appState.currentUser) promoteNextUserWithRetry();
            }
        }
        
        function startOptimizedTimer(activeUserData) {
            let lastUpdate = 0;
            function timerLoop(timestamp) {
                if (appState.timers.activeUserAnimationFrame === null) return;
                
                if (!lastUpdate || timestamp - lastUpdate >= 1000) {
                    const serverNow = Date.now() + appState.serverTimeOffset;
                    const elapsed = Math.floor((serverNow - (activeUserData.lastUpdated || serverNow)) / 1000);
                    const remaining = activeUserData.remainingTime - elapsed;
                    
                    updateTimerDisplayUI(remaining);
                    updateSummaryPanel();
                    lastUpdate = timestamp;

                    if (remaining <= 0) {
                        cancelAnimationFrame(appState.timers.activeUserAnimationFrame);
                        appState.timers.activeUserAnimationFrame = null;
                        runTransaction(ref(appState.db, 'queueSystem/activeUser'), (currentData) => {
                            return (currentData && currentData.userId === activeUserData.userId) ? null : undefined; 
                        }).then(({ committed }) => {
                            if (committed) promoteNextUserWithRetry();
                        });
                        return;
                    }
                }
                appState.timers.activeUserAnimationFrame = requestAnimationFrame(timerLoop);
            }
            appState.timers.activeUserAnimationFrame = requestAnimationFrame(timerLoop);
        }

        async function toggleTimerPause(shouldPause) {
            const activeUserRef = ref(appState.db, 'queueSystem/activeUser');
            try {
                await runTransaction(activeUserRef, (currentData) => {
                    if (!currentData || currentData.userId !== appState.currentUser?.uid || currentData.isPaused === shouldPause) return;
                    const updates = { ...currentData, isPaused: shouldPause };
                    if (shouldPause) {
                        if ((currentData.pausesUsed || 0) >= MAX_PAUSES_PER_TURN) {
                            showNotification(MESSAGES.PAUSE_LIMIT_REACHED, "error"); return;
                        }
                        const elapsed = Math.floor(((Date.now() + appState.serverTimeOffset) - currentData.lastUpdated) / 1000);
                        updates.remainingTime = Math.max(0, currentData.remainingTime - elapsed);
                        updates.pausesUsed = (currentData.pausesUsed || 0) + 1;
                        updates.pauseStartTime = serverTimestamp();
                    } else {
                        updates.lastUpdated = serverTimestamp();
                    }
                    return updates;
                });
            } catch (error) { if (handleDatabaseError(error, 'toggleTimerPause')) return; }
        }

        async function leaveTurn() {
            setButtonLoading(document.getElementById('leaveTurnBtn'), true);
            if (appState.currentUser) {
                showNotification("Has cedido tu turno.", "warning");
                await remove(ref(appState.db, `queueSystem/activeUser`));
            }
        }

        async function cleanupStaleUsers() {
            Logger.info('Ejecutando limpieza de usuarios obsoletos...');
            try {
                const cutoffTime = Date.now() - SESSION_TIMEOUT_MS;
                const updates = {};
                
                const sessionsRef = ref(appState.db, 'activeSessions');
                const sessionsSnap = await get(sessionsRef);
                if (!sessionsSnap.exists()) return;

                sessionsSnap.forEach(sessionSnap => {
                    const session = sessionSnap.val();
                    const lastHeartbeat = session.lastHeartbeat || 0;
                    if (lastHeartbeat < cutoffTime) {
                        Logger.info(`Marcando sesi贸n obsoleta para eliminar: ${session.email}`);
                        updates[`activeSessions/${sessionSnap.key}`] = null;
                        updates[`queueSystem/queue/${sessionSnap.key}`] = null;
                    }
                });

                if (Object.keys(updates).length > 0) {
                    await update(ref(appState.db), updates);
                    Logger.info(`${Object.keys(updates).length / 2} sesiones obsoletas eliminadas.`);
                }
            } catch(error) {
                Logger.error('cleanupStaleUsers', error);
            }
        }

        function renderQueue() {
            const sortedQueueArray = appState.localQueue;
            const body = UIElements.queueListBody;
            const fragment = document.createDocumentFragment();
            UIElements.queueCount.textContent = sortedQueueArray.length;

            if (sortedQueueArray.length === 0) {
                body.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay usuarios en espera</td></tr>';
            } else {
                sortedQueueArray.forEach((q, index) => {
                    const tr = createQueueRow(q, index);
                    if (tr) fragment.appendChild(tr);
                });
                body.innerHTML = '';
                body.appendChild(fragment);
            }
            updateJoinButtonState();
        }

        function createQueueRow(queueItem, index) {
            if (!queueItem || !queueItem.userId) return null;
            const tr = document.createElement('tr');
            tr.dataset.key = queueItem.userId;
            const isCurrentUser = appState.currentUser?.uid === queueItem.userId;
            if (isCurrentUser) tr.className = 'current-user';
            const actionCell = isCurrentUser ? `<button class="leave-queue-btn" data-key="${queueItem.userId}">Salir</button>` : 'En espera';
            const joinedTime = typeof queueItem.joinedAt === 'number' ? new Date(queueItem.joinedAt).toLocaleTimeString('es-DO') : '...';
            tr.innerHTML = `<td>${index + 1}</td><td>${queueItem.email || ''}</td><td>${joinedTime}</td><td>${actionCell}</td>`;
            return tr;
        }

        function updateJoinButtonState() {
            if(!appState.currentUser) return;
            const isUserInQueue = appState.localQueue.some(user => user.userId === appState.currentUser.uid);
            const isUserActive = appState.localActiveUser?.userId === appState.currentUser.uid;
            UIElements.joinQueueBtn.disabled = isUserInQueue || isUserActive;
        }
        
        function renderActiveUserUI() {
            const data = appState.localActiveUser;
            UIElements.activeUserInfo.innerHTML = data ? `<b>${data.email}</b>` : 'Nadie activo';
            UIElements.pauseInfo.innerHTML = '';
            updateJoinButtonState();

            if (data?.userId === appState.currentUser?.uid) {
                const pausesUsed = data.pausesUsed || 0;
                const pausesLeft = MAX_PAUSES_PER_TURN - pausesUsed;
                const isPaused = data.isPaused || false;

                UIElements.timerControls.innerHTML = `
                    <button id="pauseTimerBtn" class="timer-btn" data-original-text="Pausar" ${isPaused || pausesLeft <= 0 ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5m5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5"/></svg>Pausar</button>
                    <button id="resumeTimerBtn" class="timer-btn" data-original-text="Reanudar" ${!isPaused ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>Reanudar</button>
                    <button id="leaveTurnBtn" class="timer-btn leave-turn-btn" data-original-text="Ceder Turno"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/><path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/></svg>Ceder Turno</button>`;
                
                if(isPaused) UIElements.pauseInfo.textContent = `Turno en pausa. Reanudaci贸n autom谩tica en ${MAX_PAUSE_DURATION_SECONDS}s.`;
                else UIElements.pauseInfo.textContent = `Pausas restantes: ${pausesLeft}`;
            } else {
                UIElements.timerControls.innerHTML = data?.isPaused ? '<i>Turno en pausa</i>' : '';
            }
        }
        
        function updateSummaryPanel() {
             if (!appState.currentUser) { UIElements.summaryPanel.style.display = 'none'; return; }
            const myQueueIndex = appState.localQueue.findIndex(u => u.userId === appState.currentUser.uid);
            if (myQueueIndex === -1) { UIElements.summaryPanel.style.display = 'none'; return; }
            UIElements.summaryPanel.style.display = 'block';
            const usersAhead = myQueueIndex;
            let estimatedWaitSeconds = usersAhead * TURN_TIME_SECONDS;
            const activeUser = appState.localActiveUser;
            if (activeUser) {
                let remainingTime = 0;
                if (activeUser.isPaused) {
                    remainingTime = activeUser.remainingTime;
                } else if (activeUser.lastUpdated) {
                    const elapsed = Math.floor(((Date.now() + appState.serverTimeOffset) - activeUser.lastUpdated) / 1000);
                    remainingTime = Math.max(0, activeUser.remainingTime - elapsed);
                }
                estimatedWaitSeconds += remainingTime;
            }
            const waitMinutes = Math.floor(estimatedWaitSeconds / 60);
            const waitSeconds = estimatedWaitSeconds % 60;
            UIElements.summaryStats.innerHTML = `<div class="stat-item"><span class="label">Tu Posici贸n</span><span class="value">${myQueueIndex + 1}</span></div><div class="stat-item"><span class="label">Usuarios Delante</span><span class="value">${usersAhead}</span></div><div class="stat-item"><span class="label">Tiempo Estimado</span><span class="value">${waitMinutes.toString().padStart(2, '0')}:${waitSeconds.toString().padStart(2, '0')}</span></div>`;
        }
        
        function updateTimerDisplayUI(seconds) {
            const remaining = Math.max(0, Math.floor(seconds));
            UIElements.timerText.textContent = `${Math.floor(remaining / 60).toString().padStart(2, '0')}:${(remaining % 60).toString().padStart(2, '0')}`;
            const progress = Math.max(0, Math.min(1, remaining / TURN_TIME_SECONDS));
            UIElements.timerProgress.style.strokeDashoffset = 408.4 * (1 - progress);
        }

        function cleanupAll() {
            Object.values(appState.timers).forEach(timerId => {
                clearInterval(timerId);
                cancelAnimationFrame(timerId);
            });
            appState.timers = {};
            cleanupAllListeners();
        }

        function cleanupAllListeners() {
            appState.listeners.forEach(unsubscribe => unsubscribe());
            appState.listeners = [];
        }

        function startHeartbeat() {
            clearInterval(appState.timers.heartbeat);
            appState.timers.heartbeat = setInterval(() => {
                if (appState.currentUser && appState.isConnected) {
                    set(ref(appState.db, `activeSessions/${appState.currentUser.uid}/lastHeartbeat`), serverTimestamp()).catch(error => Logger.error('heartbeat', error));
                }
            }, HEARTBEAT_INTERVAL_MS);
        }

        function startPageClock() {
            clearInterval(appState.timers.pageClock);
            appState.timers.pageClock = setInterval(() => {
                UIElements.currentTime.textContent = new Date().toLocaleString('es-DO', { dateStyle: 'long', timeStyle: 'short' });
            }, 1000);
        }
        
        async function handleForgotPassword(e) {
            e.preventDefault();
            const email = UIElements.emailInput.value.trim();
            if (!email) { showError("Ingresa tu correo para restablecer la contrase帽a."); return; }
            setButtonLoading(e.target, true);
            try {
                await sendPasswordResetEmail(appState.auth, email);
                showNotification(`Se ha enviado un enlace a ${email}`, 'success');
                showError(null);
            } catch (error) { showError(getFriendlyAuthError(error.code)); }
            finally { setButtonLoading(e.target, false); }
        }
        
        function getFriendlyAuthError(errorCode) {
            const errors = {
                'auth/user-not-found': 'Correo o contrase帽a incorrectos.', 'auth/wrong-password': 'Correo o contrase帽a incorrectos.',
                'auth/invalid-email': 'El formato del correo es inv谩lido.', 'auth/too-many-requests': 'Demasiados intentos. Int茅ntalo m谩s tarde.'
            };
            return errors[errorCode] || 'Ocurri贸 un error. Por favor, int茅ntalo de nuevo.';
        }
        
        function setButtonLoading(button, isLoading, loadingText = '') {
            if (!button) return;
            const originalText = button.dataset.originalText || button.textContent;
            if (!button.dataset.originalText) {
                button.dataset.originalText = originalText;
            }
            button.disabled = isLoading;
            button.innerHTML = isLoading ? `<span class="loading-spinner"></span> ${loadingText}` : originalText;
        }

        function showError(message) {
            UIElements.userError.style.display = message ? 'block' : 'none';
            UIElements.userError.textContent = message;
        }
        
        function showQueueMessage(key, type = 'success') {
            showNotification(MESSAGES[key], type);
        }

        function showNotification(message, type = 'success') {
            const el = UIElements.notification;
            el.textContent = message;
            el.className = `notification ${type} show`;
            setTimeout(() => el.classList.remove('show'), 4000);
        }

        function showTurnNotification() {
            showNotification(MESSAGES.TURN_NOTIFICATION, 'success');
            if (Notification.permission === "granted") {
                new Notification("Sistema de Turnos", { body: `隆Es tu turno! Tienes ${TURN_TIME_SECONDS/60} minutos.`});
            }
            stopTitleNotification();
            let isTitleVisible = true;
            appState.timers.titleNotification = setInterval(() => {
                document.title = isTitleVisible ? "隆ES TU TURNO!" : appState.originalTitle;
                isTitleVisible = !isTitleVisible;
            }, 1000);
        }

        function stopTitleNotification() {
            clearInterval(appState.timers.titleNotification);
            document.title = appState.originalTitle;
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }
        
        function showErrorScreen(message) {
            cleanupAll();
            document.body.innerHTML=`<div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; text-align: center; background-color: var(--color-background);"><div style="background: var(--color-surface); padding: 40px; border-radius: var(--border-radius); box-shadow: var(--shadow); max-width: 800px;"><h2 style="color: var(--color-danger); font-size: 1.8em;"> Error Cr铆tico</h2><p style="margin: 20px 0; color: var(--color-text-primary); text-align: left;">${message}</p><button style="background:var(--color-primary); color:white; padding:12px 25px; border-radius:8px; cursor:pointer; border: none; font-size: 1em;" onclick="window.location.reload()"> Recargar P谩gina</button></div></div>`;
        }

        function handleDatabaseError(error, context) {
            Logger.error(context, error);
            if (error.message?.toUpperCase().includes('PERMISSION_DENIED')) {
                showErrorScreen(`<b>Error de Permiso:</b> La aplicaci贸n no tiene permiso para realizar esta acci贸n.`);
                return true; 
            }
            return false;
        }
    </script>
</body>
</html>
