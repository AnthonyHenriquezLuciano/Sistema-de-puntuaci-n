<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Turnos - Gestores (Sesi√≥n √önica)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            color: transparent;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .user-welcome {
            font-size: 1.2em;
            color: #2c3e50;
        }

        .user-name {
            font-weight: bold;
            color: #667eea;
        }

        .session-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .logout-btn {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .current-time {
            font-size: 1.1em;
            color: #666;
        }

        .connection-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .login-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .login-content h2 {
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.8em;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 25px;
            font-size: 1.1em;
        }

        .login-input {
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: bold;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .login-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid #f5c6cb;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid #ffeaa7;
        }

        .forgot-password {
            display: block;
            margin-top: 15px;
            color: #667eea;
            font-size: 0.9em;
            text-decoration: none;
            cursor: pointer;
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .session-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: left;
        }

        .session-details h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .session-details p {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.warning {
            background: #ffc107;
            color: #212529;
        }

        .notification.error {
            background: #dc3545;
        }

        .heartbeat-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: heartbeat 2s infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        .queue-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .queue-panel {
                grid-template-columns: 1fr;
            }
        }

        .active-user-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .active-user-panel h3 {
            color: #2c3e50;
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .timer-clock {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 20px auto;
        }

        .timer-circle {
            fill: none;
            stroke: #ddd;
            stroke-width: 10;
        }

        .timer-progress {
            fill: none;
            stroke: url(#timerGradient);
            stroke-width: 10;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 0.5s linear;
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .timer-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .timer-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .timer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .timer-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .queue-table {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }

        .queue-table h3 {
            color: #2c3e50;
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .queue-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .queue-table th, .queue-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .queue-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }

        .queue-table tr:nth-child(even) {
            background: rgba(238, 238, 238, 0.5);
        }

        .queue-table tr.current-user {
            background: rgba(102, 126, 234, 0.1);
            font-weight: bold;
        }

        .join-queue-btn {
            background: linear-gradient(135deg, #28a745, #218838);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
            text-align: center;
        }

        .join-queue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .leave-queue-btn {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .leave-queue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .queue-table tr {
            animation: fadeIn 0.3s ease-in;
        }
    </style>
</head>
<body>
    <!-- Modal de inicio de sesi√≥n -->
    <div class="login-modal" id="loginModal">
        <div class="login-content">
            <h2>üîê Inicio de Sesi√≥n Seguro</h2>
            <p class="login-subtitle">Sistema de sesi√≥n √∫nica - Ingresa con tu correo y contrase√±a</p>
            <div class="error-message" id="userError"></div>
            <div class="warning-message" id="userWarning"></div>
            <input type="email" class="login-input" id="emailInput" placeholder="Correo electr√≥nico" required>
            <input type="password" class="login-input" id="passwordInput" placeholder="Contrase√±a" required>
            <button class="login-btn" id="loginButton">
                <span id="loginButtonText">üöÄ Iniciar Sesi√≥n</span>
            </button>
            <a href="#" class="forgot-password" id="forgotPasswordLink">¬øOlvidaste tu contrase√±a?</a>
            <div class="session-details">
                <h4>üõ°Ô∏è Caracter√≠sticas de Seguridad:</h4>
                <p>‚Ä¢ Autenticaci√≥n segura con correo y contrase√±a</p>
                <p>‚Ä¢ Una sesi√≥n activa por usuario</p>
                <p>‚Ä¢ Heartbeat para mantener la conexi√≥n</p>
                <p>‚Ä¢ Limpieza autom√°tica al cerrar sesi√≥n</p>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1>üéØ Sistema de Turnos</h1>
            <p>Gesti√≥n inteligente con sesi√≥n √∫nica - M√°xima seguridad</p>
        </div>
        <div class="user-info">
            <div class="user-welcome">
                <div>
                    <span class="heartbeat-indicator"></span>
                    üëã Bienvenido/a, <span class="user-name" id="userName">Cargando...</span>
                </div>
                <div class="session-info" id="sessionInfo">
                    Sesi√≥n iniciada: <span id="sessionStart"></span>
                </div>
                <div class="connection-status" id="connectionStatus">Conectando...</div>
            </div>
            <div>
                <div class="current-time" id="currentTime"></div>
                <button class="logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>
        <div class="main-content">
            <!-- Panel de Cola y Turnos Mejorado -->
            <div class="queue-panel">
                <div class="active-user-panel">
                    <h3>Usuario Activo</h3>
                    <div id="activeUserInfo">Nadie activo</div>
                    <div class="timer-clock">
                        <svg width="150" height="150">
                            <defs>
                                <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <circle class="timer-circle" cx="75" cy="75" r="65" />
                            <circle class="timer-progress" cx="75" cy="75" r="65" stroke-dasharray="408.4" stroke-dashoffset="408.4" id="timerProgress" />
                        </svg>
                        <div class="timer-text" id="timerText">15:00</div>
                    </div>
                    <div id="timerControls" class="timer-controls"></div>
                </div>
                <div class="queue-table">
                    <h3>Cola de Espera</h3>
                    <table id="queueList">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Usuario</th>
                                <th>Hora de Ingreso</th>
                                <th>Estado</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button id="joinQueueBtn" class="join-queue-btn">üìù Unirse a la Cola</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Firebase SDKs (actualizados a la √∫ltima versi√≥n compatible) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
    // CONFIGURACI√ìN DE FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyAs2MmgrO0UmXtlm-HWCw2hcfqYcIg74Qs",
        authDomain: "sistema-turnos-gestores.firebaseapp.com",
        databaseURL: "https://sistema-turnos-gestores-default-rtdb.firebaseio.com",
        projectId: "sistema-turnos-gestores",
        storageBucket: "sistema-turnos-gestores.appspot.com",
        messagingSenderId: "322320112231",
        appId: "1:322320112231:web:dbb93a76a85a8906d2d2c2",
        measurementId: "G-GV4JVLKEFY"
    };

    // Variables globales
    let currentUser = null; [cite: 111]
    let sessionId = null; [cite: 111]
    let sessionStartTime = null; [cite: 112]
    let heartbeatInterval = null; [cite: 112]
    let sessionCheckInterval = null; [cite: 112]
    let isConnected = false; [cite: 112]
    let isLoggingIn = false; [cite: 112]
    let hasBeenNotified = false; [cite: 113]
    let globalTimerInterval = null; [cite: 113]

    // Constantes de configuraci√≥n
    const HEARTBEAT_INTERVAL = 30000; [cite: 114]
    const SESSION_CHECK_INTERVAL = 10000; [cite: 114]
    const MAX_HEARTBEAT_RETRIES = 3; [cite: 114]
    const TURN_TIME = 15 * 60; [cite: 114]

    // Referencias de Firebase
    let database, auth, activeSessionsRef, connectedRef, queueRef, activeUserRef; [cite: 115]

    // Rutas de Firebase para la cola
    const QUEUE_PATH = 'queueSystem/queue'; [cite: 116]
    const ACTIVE_USER_PATH = 'queueSystem/activeUser'; [cite: 117]

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', initializeApp); [cite: 118]

    async function initializeApp() { [cite: 118]
        console.log('Iniciando initializeApp'); [cite: 119]
        try {
            if (typeof window.firebase === 'undefined' || !window.firebase.app || !window.firebase.database || !window.firebase.auth) { [cite: 120]
                throw new Error('Firebase SDK no cargado correctamente. Revisa la consola para m√°s detalles.'); [cite: 122]
            }
            console.log('Firebase SDKs cargados correctamente'); [cite: 123]

            firebase.initializeApp(firebaseConfig); [cite: 124]
            database = firebase.database(); [cite: 127]
            auth = firebase.auth(); [cite: 128]
            activeSessionsRef = database.ref('activeSessions'); [cite: 128]
            connectedRef = database.ref('.info/connected'); [cite: 128]
            queueRef = database.ref(QUEUE_PATH); [cite: 128]
            activeUserRef = database.ref(ACTIVE_USER_PATH); [cite: 128]
            console.log('Firebase inicializado con √©xito'); [cite: 129]

            setupConnectionListener();
            setupLoginUI();
            updateCurrentTime(); [cite: 133]
            setInterval(updateCurrentTime, 1000); [cite: 133]
            
            setupQueueSystem();
            setupGlobalTimerListener();
            requestNotificationPermission();

        } catch (error) {
            console.error('Error Cr√≠tico en initializeApp:', error); [cite: 134]
            showErrorScreen(`Error al inicializar: ${error.message || 'Error desconocido. Revisa la consola.'}`); [cite: 135]
        }
    }

    function requestNotificationPermission() {
        if (!("Notification" in window)) { [cite: 137]
            console.warn("El navegador no soporta notificaciones."); [cite: 137]
            return;
        }
        Notification.requestPermission().then(permission => { [cite: 138]
            if (permission === "granted") { [cite: 138]
                console.log("Permiso de notificaciones concedido."); [cite: 138]
            } else {
                showNotification("Notificaciones desactivadas. No recibir√°s alertas de turno.", 'warning'); [cite: 138]
            }
        }).catch(error => { [cite: 139]
            console.error("Error solicitando permisos de notificaci√≥n:", error); [cite: 139]
        });
    }

    function showSystemNotification(message) {
        if (Notification.permission === "granted") { [cite: 140]
            new Notification("Sistema de Turnos", { [cite: 140]
                body: message,
            });
        }
    }

    function setupQueueSystem() {
        setupQueueListeners(); [cite: 142]
        const joinQueueBtn = document.getElementById('joinQueueBtn'); [cite: 142]
        if (joinQueueBtn) {
            joinQueueBtn.onclick = joinQueue; [cite: 143]
        } else {
            console.error('Bot√≥n joinQueueBtn no encontrado'); [cite: 144]
        }
    }

    async function joinQueue() {
        if (!isConnected) { [cite: 145]
            return showNotification('Sin conexi√≥n al servidor. Verifica tu conexi√≥n a internet.', 'error'); [cite: 146]
        }
        if (!currentUser) { [cite: 147]
            return showNotification('Debes iniciar sesi√≥n para unirte a la cola', 'warning'); [cite: 147]
        }

        try {
            const activeUserSnapshot = await activeUserRef.once('value'); [cite: 151]
            if (activeUserSnapshot.exists()) {
                const activeUser = activeUserSnapshot.val(); [cite: 153]
                if (activeUser.userId === currentUser.uid) { [cite: 154]
                    return showNotification('No puedes unirte a la cola mientras est√°s activo', 'warning'); [cite: 154]
                }
            }

            const queueSnapshot = await queueRef.once('value'); [cite: 157]
            const queue = queueSnapshot.val() || {}; [cite: 161]
            const isInQueue = Object.values(queue).some(q => q && q.userId === currentUser.uid); [cite: 162]

            if (isInQueue) {
                return showNotification('Ya est√°s en la cola', 'warning'); [cite: 163]
            }

            const newRef = queueRef.push();
            const queueEntry = {
                userId: currentUser.uid,
                email: currentUser.email,
                joinedAt: firebase.database.ServerValue.TIMESTAMP
            };
            await newRef.set(queueEntry); [cite: 167]
            showNotification('Te uniste a la cola con √©xito', 'success'); [cite: 167]

            // Si no hay nadie activo, intenta activar al siguiente (que ser√≠as t√∫).
            if (!activeUserSnapshot.exists()) { [cite: 173]
                await activateNextInQueue(); [cite: 173]
            }
        } catch (error) {
            console.error('Error al unirse a la cola:', error); [cite: 174]
            showNotification(`Error al unirse a la cola: ${error.message}`, 'error'); [cite: 178]
        }
    }
    
    async function leaveQueue(queueKey) {
        if (!currentUser || !queueKey) { [cite: 183]
            return showNotification('Error: No se puede identificar tu usuario o tu posici√≥n en la cola.', 'error'); [cite: 184]
        }
        try {
            await queueRef.child(queueKey).remove(); [cite: 186]
            showNotification('Has salido de la cola con √©xito', 'success'); [cite: 187]
        } catch (error) {
            console.error('Error al salir de la cola:', error); [cite: 188]
            showNotification(`Error al salir de la cola: ${error.message}`, 'error'); [cite: 188]
        }
    }

    async function activateNextInQueue() {
        try {
            const activeUserSnap = await activeUserRef.once('value');
            if (activeUserSnap.exists()) {
                // Ya hay alguien activo, no hacer nada.
                return;
            }

            const queueSnap = await queueRef.orderByChild('joinedAt').limitToFirst(1).once('value'); [cite: 191]
            if (!queueSnap.exists()) {
                console.log('No hay usuarios en la cola para activar.'); [cite: 192]
                await activeUserRef.remove(); [cite: 192]
                return;
            }

            const queueData = queueSnap.val();
            const [key, userToActivate] = Object.entries(queueData)[0];
            
            const activeUserData = {
                userId: userToActivate.userId, [cite: 194]
                email: userToActivate.email, [cite: 194]
                startTime: firebase.database.ServerValue.TIMESTAMP, [cite: 195]
                remainingTime: TURN_TIME, [cite: 195]
                isPaused: false [cite: 195]
            };

            await activeUserRef.set(activeUserData); [cite: 196]
            await queueRef.child(key).remove(); [cite: 197]

        } catch (error) {
            console.error('Error al activar el siguiente usuario:', error); [cite: 199]
        }
    }

    function setupQueueListeners() {
        activeUserRef.on('value', snap => { [cite: 202]
            const data = snap.val(); [cite: 203]
            renderActiveUser(data); [cite: 203]
            if (data && data.userId === currentUser?.uid && !hasBeenNotified) { [cite: 203]
                showNotification('¬°Es tu turno!', 'success'); [cite: 204]
                showSystemNotification('¬°Es tu turno! Por favor, regresa al sistema de turnos.'); [cite: 204]
                hasBeenNotified = true; [cite: 205]
            } else if (!data || data.userId !== currentUser?.uid) { [cite: 206]
                hasBeenNotified = false;
            }
        }, error => {
            console.error('Error en el listener de activeUser:', error); [cite: 207]
        });

        queueRef.on('value', snap => { [cite: 209]
            const queueData = snap.val(); [cite: 209]
            renderQueue(queueData);
        }, error => {
            console.error('Error en el listener de queue:', error); [cite: 210]
        });
    }

    function setupGlobalTimerListener() {
        activeUserRef.on('value', (snap) => { [cite: 214]
            stopGlobalTimer('Actualizaci√≥n recibida desde Firebase.');
            const data = snap.val(); [cite: 214]
            if (data && !data.isPaused) { [cite: 214]
                startGlobalTimer(data); [cite: 214]
            } else {
                updateTimerDisplayUI(data ? data.remainingTime : TURN_TIME); [cite: 215]
            }
        }, error => {
            console.error("Error escuchando al usuario activo para el timer:", error); [cite: 217]
        });
    }

    function startGlobalTimer(activeUserData) {
        stopGlobalTimer('Iniciando un nuevo temporizador.'); // Asegura que no haya timers duplicados
        let remaining = activeUserData.remainingTime;
        
        // Sincronizaci√≥n inicial
        updateTimerDisplayUI(remaining);

        globalTimerInterval = setInterval(() => { [cite: 223]
            remaining--;
            if (remaining <= 0) {
                stopGlobalTimer('Tiempo expirado.');
                updateTimerDisplayUI(0);
                // Solo el cliente del usuario activo debe finalizar el turno.
                if (activeUserData.userId === currentUser?.uid) {
                    activeUserRef.remove().then(() => activateNextInQueue()); [cite: 227]
                }
            } else {
                updateTimerDisplayUI(remaining);
            }
        }, 1000);
    }
    
    function stopGlobalTimer(reason) {
        if (globalTimerInterval) { [cite: 240]
            clearInterval(globalTimerInterval); [cite: 241]
            globalTimerInterval = null; [cite: 241]
        }
    }

    function updateTimerDisplayUI(remainingSeconds) {
        const timerTextElement = document.getElementById('timerText'); [cite: 243]
        const timerProgressElement = document.getElementById('timerProgress'); [cite: 243]

        if (timerTextElement && timerProgressElement) { [cite: 244]
            timerTextElement.textContent = formatTime(Math.max(0, Math.floor(remainingSeconds))); [cite: 244]
            const totalDash = 408.4; [cite: 244]
            const progress = Math.max(0, remainingSeconds) / TURN_TIME;
            timerProgressElement.style.strokeDashoffset = totalDash * (1 - progress); [cite: 245]
        }
    }

    function renderActiveUser(data) {
        const activeUserInfo = document.getElementById('activeUserInfo'); [cite: 247]
        const timerControls = document.getElementById('timerControls'); [cite: 247]
        if (!activeUserInfo || !timerControls) { [cite: 248]
            return console.error('Elementos de UI de usuario activo no encontrados'); [cite: 248]
        }

        if (!data) {
            activeUserInfo.innerHTML = 'Nadie activo'; [cite: 249]
            timerControls.innerHTML = ''; [cite: 249]
            updateTimerDisplayUI(TURN_TIME);
            return;
        }

        activeUserInfo.innerHTML = `<b>${data.email}</b>`; [cite: 250]
        if (data.userId === currentUser?.uid) { [cite: 250]
            timerControls.innerHTML = `
                <button id="pauseTimerBtn" class="timer-btn" ${data.isPaused ? 'disabled' : ''}><span>‚è∏Ô∏è</span> Pausar</button>
                <button id="resumeTimerBtn" class="timer-btn" ${!data.isPaused ? 'disabled' : ''}><span>‚ñ∂Ô∏è</span> Reanudar</button>
            `; [cite: 252]
            const pauseBtn = document.getElementById('pauseTimerBtn'); [cite: 253]
            const resumeBtn = document.getElementById('resumeTimerBtn'); [cite: 253]
            if (pauseBtn) pauseBtn.onclick = pauseTimer; [cite: 253]
            if (resumeBtn) resumeBtn.onclick = resumeTimer; [cite: 253]
        } else {
            timerControls.innerHTML = ''; [cite: 255]
        }
    }

    function renderQueue(queueData) {
        const queueListBody = document.querySelector('#queueList tbody'); [cite: 256]
        if (!queueListBody) { [cite: 257]
            return console.error('Elemento queueList tbody no encontrado'); [cite: 257]
        }

        queueListBody.innerHTML = ''; [cite: 258]
        if (!queueData || Object.keys(queueData).length === 0) { [cite: 258]
            const tr = document.createElement('tr'); [cite: 259]
            tr.innerHTML = '<td colspan="5">No hay usuarios en espera</td>'; [cite: 259]
            queueListBody.appendChild(tr); [cite: 259]
            return;
        }
        
        Object.entries(queueData).sort(([, a], [, b]) => a.joinedAt - b.joinedAt) [cite: 260]
            .forEach(([key, q], i) => {
                const tr = document.createElement('tr'); [cite: 260]
                if (q.userId === currentUser?.uid) tr.classList.add('current-user'); [cite: 260]
                
                const leaveButton = q.userId === currentUser?.uid 
                    ? `<button class="leave-queue-btn" onclick="leaveQueue('${key}')">üöó Salir</button>` [cite: 261]
                    : '';
                
                tr.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${q.email}</td>
                    <td>${new Date(q.joinedAt).toLocaleTimeString('es-ES')}</td>
                    <td>En espera</td>
                    <td>${leaveButton}</td>
                `; [cite: 262]
                queueListBody.appendChild(tr); [cite: 264]
            });
    }

    function pauseTimer() {
        if (!currentUser) return;
        activeUserRef.update({ isPaused: true }).catch(error => console.error('Error al pausar el temporizador:', error)); [cite: 266]
    }

    function resumeTimer() {
        if (!currentUser) return;
        activeUserRef.update({ isPaused: false }).catch(error => console.error('Error al reanudar el temporizador:', error)); [cite: 271]
    }

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    async function cleanupQueueOnLogout() {
        if (!currentUser) return; [cite: 275]
        
        try {
            // Salir de la cola de espera
            const queueSnap = await queueRef.orderByChild('userId').equalTo(currentUser.uid).once('value');
            if (queueSnap.exists()) {
                const queueData = queueSnap.val();
                const queueKey = Object.keys(queueData)[0];
                await queueRef.child(queueKey).remove(); [cite: 277]
            }

            // Si es el usuario activo, ceder el turno
            const activeUserSnap = await activeUserRef.once('value');
            if (activeUserSnap.exists() && activeUserSnap.val().userId === currentUser.uid) { [cite: 279]
                await activeUserRef.remove(); [cite: 279]
                await activateNextInQueue(); [cite: 280]
            }
        } catch (error) {
            console.error('Error limpiando la cola al cerrar sesi√≥n:', error); [cite: 281]
        }
    }

    function setupConnectionListener() {
        if (!connectedRef) return; [cite: 290]

        connectedRef.on('value', snap => {
            isConnected = snap.val(); [cite: 292]
            updateConnectionStatus(); [cite: 292]
            if (isConnected && currentUser && sessionId) { [cite: 293]
                startHeartbeat();
                checkSessionValidity();
            } else if (!isConnected) {
                showNotification('Conexi√≥n perdida. Intentando reconectar...', 'warning'); [cite: 295]
            }
        }, error => {
            console.error('Error en listener de conexi√≥n:', error); [cite: 298]
        });
    }

    function setupLoginUI() {
        const loginModal = document.getElementById('loginModal'); [cite: 300]
        const emailInput = document.getElementById('emailInput'); [cite: 94]
        const passwordInput = document.getElementById('passwordInput'); [cite: 94]
        const loginButton = document.getElementById('loginButton'); [cite: 94]
        const forgotPasswordLink = document.getElementById('forgotPasswordLink'); [cite: 94]

        if (!loginModal || !emailInput || !passwordInput || !loginButton || !forgotPasswordLink) { [cite: 304]
            return showErrorScreen('Error cr√≠tico: No se encontraron los elementos de la UI de login.'); [cite: 304]
        }

        loginModal.style.display = 'flex'; [cite: 22, 23]
        
        loginButton.onclick = handleLoginClick; [cite: 306]
        
        passwordInput.addEventListener('keypress', (e) => { [cite: 307]
            if (e.key === 'Enter') { [cite: 307]
                handleLoginClick(e); [cite: 307]
            }
        });
        
        forgotPasswordLink.onclick = handleForgotPassword;
    }

    function startHeartbeat() {
        stopHeartbeat(); // Detener cualquier heartbeat anterior
        console.log('Iniciando heartbeat'); [cite: 311]
        sendHeartbeat(); // Enviar uno inmediatamente
        heartbeatInterval = setInterval(sendHeartbeat, HEARTBEAT_INTERVAL); [cite: 313]
    }

    function stopHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval); [cite: 312]
            heartbeatInterval = null;
        }
    }

    async function sendHeartbeat() {
        if (!currentUser || !sessionId || !isConnected) { [cite: 315]
            return;
        }
        
        try {
            await activeSessionsRef.child(currentUser.uid).update({
                lastHeartbeatTime: firebase.database.ServerValue.TIMESTAMP
            });
            console.log("Heartbeat enviado."); [cite: 330]
        } catch(error) {
            console.error("Error enviando heartbeat:", error); [cite: 331]
        }
    }

    async function handleLoginClick(e) {
        if (isLoggingIn) return; [cite: 338]

        const emailInput = document.getElementById('emailInput'); [cite: 94]
        const passwordInput = document.getElementById('passwordInput'); [cite: 94]
        const loginButton = document.getElementById('loginButton'); [cite: 94]
        const loginButtonText = document.getElementById('loginButtonText'); [cite: 94]

        const email = emailInput.value.trim(); [cite: 348]
        const password = passwordInput.value; [cite: 348]

        if (!email || !password) { [cite: 348]
            return showError('Por favor, ingresa correo y contrase√±a.'); [cite: 349]
        }
        if (!isConnected) { [cite: 350]
            return showNotification('Sin conexi√≥n al servidor.', 'error'); [cite: 350]
        }

        isLoggingIn = true; [cite: 351]
        loginButton.disabled = true; [cite: 351]
        loginButtonText.innerHTML = '<span class="loading-spinner"></span> Verificando...'; [cite: 352]

        try {
            await handleUniqueLogin(email, password); [cite: 353]
        } catch (error) {
            showError(error.message); [cite: 354]
        } finally {
            isLoggingIn = false; [cite: 356]
            loginButton.disabled = false; [cite: 356]
            loginButtonText.innerHTML = 'üöÄ Iniciar Sesi√≥n'; [cite: 94]
        }
    }

    async function handleUniqueLogin(email, password) {
        // 1. Autenticar al usuario
        let userCredential;
        try {
            userCredential = await auth.signInWithEmailAndPassword(email, password); [cite: 360]
        } catch (authError) {
            throw new Error('Credenciales incorrectas. Por favor, verifica tu correo y contrase√±a.'); [cite: 361]
        }
        const user = userCredential.user; [cite: 360]

        // 2. Verificar si ya hay una sesi√≥n activa
        const sessionRef = activeSessionsRef.child(user.uid);
        const sessionSnapshot = await sessionRef.once('value'); [cite: 362]
        if (sessionSnapshot.exists()) { [cite: 362]
            await auth.signOut(); [cite: 363]
            throw new Error(`El usuario ${email} ya tiene una sesi√≥n activa en otro lugar.`); [cite: 364]
        }

        // 3. Crear la nueva sesi√≥n
        const newSessionId = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`; [cite: 366]
        const now = firebase.database.ServerValue.TIMESTAMP;
        const newSessionData = {
            userId: user.uid, [cite: 367]
            email: user.email, [cite: 367]
            sessionId: newSessionId, [cite: 367]
            loginTime: now, [cite: 367]
            lastHeartbeatTime: now, [cite: 368]
            userAgent: navigator.userAgent [cite: 369]
        };
        await sessionRef.set(newSessionData); [cite: 370]
        
        // La sesi√≥n se elimina autom√°ticamente si el cliente se desconecta.
        await sessionRef.onDisconnect().remove();

        // 4. Configurar el estado de la aplicaci√≥n local
        currentUser = user; [cite: 373]
        sessionId = newSessionId; [cite: 373]
        sessionStartTime = Date.now(); [cite: 373]

        document.getElementById('userName').textContent = currentUser.email; [cite: 374]
        document.getElementById('sessionStart').textContent = new Date(sessionStartTime).toLocaleString('es-ES');
        document.getElementById('loginModal').style.display = 'none'; [cite: 22]
        document.getElementById('mainContainer').style.display = 'block';

        startHeartbeat();
        startSessionMonitoring();
        showNotification(`üëã ¬°Bienvenido/a, ${currentUser.email}!`, 'success'); [cite: 375]
    }

    async function handleForgotPassword(event) {
        event.preventDefault(); [cite: 378]
        const emailInput = document.getElementById('emailInput'); [cite: 94]
        const email = emailInput.value.trim(); [cite: 383]
        if (!email) { [cite: 383]
            return showError('Por favor, ingresa tu correo electr√≥nico para restablecer la contrase√±a.'); [cite: 384]
        }

        try {
            await auth.sendPasswordResetEmail(email); [cite: 385]
            showWarning('Se ha enviado un enlace para restablecer tu contrase√±a a tu correo electr√≥nico.');
        } catch (error) {
            showError(`Error al enviar el enlace: ${error.message}`); [cite: 387]
        }
    }
    
    function startSessionMonitoring() {
        if (!currentUser) return;
        const sessionRef = activeSessionsRef.child(currentUser.uid); [cite: 389]
        
        sessionCheckInterval = setInterval(async () => { [cite: 398]
            if (!currentUser) return;
            try {
                const snapshot = await sessionRef.once('value'); [cite: 402]
                if (!snapshot.exists()) { [cite: 403]
                    forceLogout('Tu sesi√≥n ha sido cerrada externamente (posiblemente por inactividad).'); [cite: 403]
                } else {
                    const sessionData = snapshot.val(); [cite: 404]
                    if (sessionData.sessionId !== sessionId) { [cite: 404]
                        forceLogout('Se ha iniciado una nueva sesi√≥n en otro dispositivo.'); [cite: 405]
                    }
                }
            } catch (error) {
                console.error("Error verificando la validez de la sesi√≥n:", error); [cite: 407]
            }
        }, SESSION_CHECK_INTERVAL); [cite: 398]
    }

    async function logout() {
        if (!currentUser) return;
        try {
            await cleanupQueueOnLogout(); [cite: 411]
            // Al eliminar la referencia, se activar√° onDisconnect().remove() si a√∫n est√° pendiente, o simplemente la elimina.
            await activeSessionsRef.child(currentUser.uid).remove(); [cite: 410]
            await auth.signOut(); [cite: 410]
        } catch (error) {
            console.error('Error durante el logout:', error); [cite: 412]
        } finally {
            cleanupSession(); [cite: 411]
            showNotification('Sesi√≥n cerrada correctamente', 'success'); [cite: 411]
        }
    }
    
    function forceLogout(reason = 'Raz√≥n desconocida') {
        showNotification(`Sesi√≥n terminada: ${reason}`, 'warning'); [cite: 414]
        cleanupSession();
    }

    function cleanupSession() {
        stopHeartbeat();
        if (sessionCheckInterval) { [cite: 418]
            clearInterval(sessionCheckInterval); [cite: 418]
            sessionCheckInterval = null; [cite: 418]
        }
        
        // Limpiar referencias de Firebase que escuchan eventos.
        if (currentUser) {
            activeSessionsRef.child(currentUser.uid).off(); [cite: 419]
        }
        activeUserRef.off();
        queueRef.off();

        currentUser = null; [cite: 420]
        sessionId = null; [cite: 420]
        sessionStartTime = null; [cite: 420]
        hasBeenNotified = false; [cite: 420]
        isLoggingIn = false;
        
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('loginModal').style.display = 'flex'; [cite: 22, 23]
        setupLoginUI(); // Re-configura la UI de login para un nuevo inicio de sesi√≥n.
    }

    function updateConnectionStatus() {
        const statusElement = document.getElementById('connectionStatus'); [cite: 98]
        if (statusElement) {
            statusElement.textContent = isConnected ? 'üü¢ Conectado' : 'üî¥ Desconectado'; [cite: 424]
            statusElement.className = `connection-status ${isConnected ? 'connected' : 'disconnected'}`; [cite: 19, 20, 21]
        }
    }

    function updateCurrentTime() {
        const currentTimeElement = document.getElementById('currentTime'); [cite: 99]
        if (currentTimeElement) {
            currentTimeElement.textContent = new Date().toLocaleString('es-ES', {
                dateStyle: 'full',
                timeStyle: 'medium'
            });
        }
    }

    function showError(message) {
        const errorElement = document.getElementById('userError'); [cite: 94]
        const warningElement = document.getElementById('userWarning'); [cite: 94]
        if (errorElement && warningElement) {
            warningElement.style.display = 'none'; [cite: 39]
            if (message) {
                errorElement.textContent = message; [cite: 432]
                errorElement.style.display = 'block'; [cite: 432]
            } else {
                errorElement.style.display = 'none'; [cite: 433]
            }
        }
    }

    function showWarning(message) {
        const errorElement = document.getElementById('userError'); [cite: 94]
        const warningElement = document.getElementById('userWarning'); [cite: 94]
        if (errorElement && warningElement) {
            errorElement.style.display = 'none'; [cite: 37]
             if (message) {
                warningElement.textContent = message;
                warningElement.style.display = 'block'; [cite: 39]
            } else {
                warningElement.style.display = 'none'; [cite: 39]
            }
        }
    }

    function showNotification(message, type = 'success') {
        const notificationElement = document.getElementById('notification'); [cite: 54]
        if (notificationElement) {
            notificationElement.textContent = message; [cite: 435]
            notificationElement.className = `notification ${type} show`; [cite: 55, 56, 57]
            setTimeout(() => {
                notificationElement.classList.remove('show');
            }, 4000);
        }
    }

    function showErrorScreen(message) {
        console.error("Mostrando pantalla de error:", message); [cite: 438]
        document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: #f4f4f4;">
                <div style="background: #fff; padding: 40px; border-radius: 10px; text-align: center; max-width: 600px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);">
                    <h2 style="color: #dc3545; margin-bottom: 20px;">üÜò Error Cr√≠tico del Sistema</h2>
                    <p style="color: #333; margin-bottom: 30px; font-size: 1.1em;">${message}</p>
                    <p style="color: #666; margin-bottom: 30px;">Esto puede deberse a un problema de red o a un error en la configuraci√≥n. Por favor, revisa la consola del navegador para m√°s detalles.</p>
                    <button style="background: #667eea; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 1em;" onclick="window.location.reload()">üîÑ Recargar la p√°gina</button>
                </div>
            </div>`; [cite: 440]
    }
</script>
</body>
</html>
