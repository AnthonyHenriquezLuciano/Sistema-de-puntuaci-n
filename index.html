<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Turnos - Gestores (Sesi√≥n √önica)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); border-radius: 20px; padding: 30px; text-align: center; margin-bottom: 30px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); }
        .header h1 { color: #2c3e50; font-size: 2.5em; margin-bottom: 10px; background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; color: transparent; }
        .user-info { background: rgba(255, 255, 255, 0.9); border-radius: 15px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        .user-welcome { font-size: 1.2em; color: #2c3e50; }
        .user-name { font-weight: bold; color: #667eea; }
        .session-info { font-size: 0.9em; color: #666; margin-top: 5px; }
        .logout-btn { background: linear-gradient(45deg, #dc3545, #c82333); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; }
        .logout-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3); }
        .current-time { font-size: 1.1em; color: #666; }
        .connection-status { padding: 5px 10px; border-radius: 20px; font-size: 0.9em; font-weight: bold; }
        .connection-status.connected { background: #d4edda; color: #155724; }
        .connection-status.disconnected { background: #f8d7da; color: #721c24; }
        .login-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center; }
        .login-content { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 450px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); text-align: center; }
        .login-content h2 { margin-bottom: 25px; color: #2c3e50; font-size: 1.8em; }
        .login-subtitle { color: #666; margin-bottom: 25px; font-size: 1.1em; }
        .login-input { width: 100%; padding: 15px 20px; margin-bottom: 20px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; transition: all 0.3s ease; }
        .login-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .login-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1em; cursor: pointer; transition: all 0.3s ease; width: 100%; font-weight: bold; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .login-btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; box-shadow: none; }
        .error-message { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; border: 1px solid #f5c6cb; }
        .warning-message { background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; margin-bottom: 20px; display: none; border: 1px solid #ffeaa7; }
        .forgot-password { display: block; margin-top: 15px; color: #667eea; font-size: 0.9em; text-decoration: none; cursor: pointer; }
        .forgot-password:hover { text-decoration: underline; }
        .session-details { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left; }
        .session-details h4 { color: #2c3e50; margin-bottom: 10px; }
        .session-details p { margin-bottom: 5px; font-size: 0.9em; color: #666; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; vertical-align: middle;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .main-content { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); border-radius: 20px; padding: 30px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); }
        .notification { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); transform: translateX(400px); opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 1000; }
        .notification.show { transform: translateX(0); opacity: 1; }
        .notification.warning { background: #ffc107; color: #212529; }
        .notification.error { background: #dc3545; }
        .heartbeat-indicator { display: inline-block; width: 8px; height: 8px; background: #28a745; border-radius: 50%; margin-right: 8px; animation: heartbeat 2s infinite; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } }
        .queue-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); border-radius: 20px; padding: 30px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); margin-top: 30px; display: grid; grid-template-columns: 1fr 2fr; gap: 30px; }
        @media (max-width: 768px) { .queue-panel { grid-template-columns: 1fr; } }
        .active-user-panel { background: #f8f9fa; border-radius: 15px; padding: 20px; text-align: center; }
        .active-user-panel h3 { color: #2c3e50; font-size: 1.5em; margin-bottom: 15px; }
        .timer-clock { position: relative; width: 150px; height: 150px; margin: 20px auto; }
        .timer-circle { fill: none; stroke: #ddd; stroke-width: 10; }
        .timer-progress { fill: none; stroke: url(#timerGradient); stroke-width: 10; stroke-linecap: round; transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 0.5s linear; }
        .timer-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2em; font-weight: bold; color: #2c3e50; }
        .timer-controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        .timer-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px; }
        .timer-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .timer-btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; box-shadow: none; }
        .queue-table { background: #f8f9fa; border-radius: 15px; padding: 20px; }
        .queue-table h3 { color: #2c3e50; font-size: 1.5em; margin-bottom: 15px; }
        .queue-table table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .queue-table th, .queue-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .queue-table th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: bold; }
        .queue-table tr:nth-child(even) { background: rgba(238, 238, 238, 0.5); }
        .queue-table tr.current-user { background: rgba(102, 126, 234, 0.1); font-weight: bold; }
        .join-queue-btn { background: linear-gradient(135deg, #28a745, #218838); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1.1em; margin-top: 20px; transition: all 0.3s ease; display: block; width: 100%; text-align: center; }
        .join-queue-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3); }
        .leave-queue-btn { background: linear-gradient(45deg, #dc3545, #c82333); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; }
        .leave-queue-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .queue-table tr { animation: fadeIn 0.3s ease-in; }
    </style>
</head>
<body>
    <div class="login-modal" id="loginModal">
        <div class="login-content">
            <h2>üîê Inicio de Sesi√≥n Seguro</h2>
            <p class="login-subtitle">Sistema de sesi√≥n √∫nica - Ingresa con tu correo y contrase√±a</p>
            <div class="error-message" id="userError"></div>
            <div class="warning-message" id="userWarning"></div>
            <input type="email" class="login-input" id="emailInput" placeholder="Correo electr√≥nico" required>
            <input type="password" class="login-input" id="passwordInput" placeholder="Contrase√±a" required>
            <button class="login-btn" id="loginButton">
                <span id="loginButtonText">üöÄ Iniciar Sesi√≥n</span>
            </button>
            <a href="#" class="forgot-password" id="forgotPasswordLink">¬øOlvidaste tu contrase√±a?</a>
            <div class="session-details">
                <h4>üõ°Ô∏è Caracter√≠sticas de Seguridad:</h4>
                <p>‚Ä¢ Autenticaci√≥n segura con correo y contrase√±a</p>
                <p>‚Ä¢ Una sesi√≥n activa por usuario a la vez</p>
                <p>‚Ä¢ Heartbeat para mantener la conexi√≥n</p>
                <p>‚Ä¢ Limpieza autom√°tica al cerrar sesi√≥n</p>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1>üéØ Sistema de Turnos</h1>
            <p>Gesti√≥n inteligente con sesi√≥n √∫nica - M√°xima seguridad</p>
        </div>
        <div class="user-info">
            <div class="user-welcome">
                <div>
                    <span class="heartbeat-indicator"></span>
                    üëã Bienvenido/a, <span class="user-name" id="userName">Cargando...</span>
                </div>
                <div class="session-info" id="sessionInfo">
                    Sesi√≥n iniciada: <span id="sessionStart"></span>
                </div>
                <div class="connection-status" id="connectionStatus">Conectando...</div>
            </div>
            <div>
                <div class="current-time" id="currentTime"></div>
                <button class="logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>
        <div class="main-content">
            <div class="queue-panel">
                <div class="active-user-panel">
                    <h3>Usuario Activo</h3>
                    <div id="activeUserInfo">Nadie activo</div>
                    <div class="timer-clock">
                        <svg width="150" height="150" viewBox="0 0 150 150">
                            <defs>
                                <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <circle class="timer-circle" cx="75" cy="75" r="65" />
                            <circle class="timer-progress" id="timerProgress" cx="75" cy="75" r="65" stroke-dasharray="408.4" stroke-dashoffset="408.4" />
                        </svg>
                        <div class="timer-text" id="timerText">15:00</div>
                    </div>
                    <div id="timerControls" class="timer-controls"></div>
                </div>
                <div class="queue-table">
                    <h3>Cola de Espera</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Usuario</th>
                                <th>Hora de Ingreso</th>
                                <th>Estado</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="queueListBody"></tbody>
                    </table>
                    <button id="joinQueueBtn" class="join-queue-btn">üìù Unirse a la Cola</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // =================================================================================
        // CONFIGURACI√ìN E INICIALIZACI√ìN
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAs2MmgrO0UmXtlm-HWCw2hcfqYcIg74Qs",
            authDomain: "sistema-turnos-gestores.firebaseapp.com",
            databaseURL: "https://sistema-turnos-gestores-default-rtdb.firebaseio.com",
            projectId: "sistema-turnos-gestores",
            storageBucket: "sistema-turnos-gestores.appspot.com",
            messagingSenderId: "322320112231",
            appId: "1:322320112231:web:dbb93a76a85a8906d2d2c2",
            measurementId: "G-GV4JVLKEFY"
        };

        let currentUser = null, sessionId = null, sessionStartTime = null;
        let heartbeatInterval = null, sessionCheckInterval = null, globalTimerInterval = null, syncInterval = null;
        let isConnected = false, isLoggingIn = false, hasBeenNotified = false;

        const HEARTBEAT_INTERVAL = 30000;
        const SESSION_CHECK_INTERVAL = 10000;
        const TURN_TIME = 15 * 60;
        const SYNC_INTERVAL_SECONDS = 5;

        let database, auth, activeSessionsRef, connectedRef, queueRef, activeUserRef;
        const QUEUE_PATH = 'queueSystem/queue';
        const ACTIVE_USER_PATH = 'queueSystem/activeUser';

        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            try {
                if (typeof window.firebase === 'undefined') {
                    throw new Error('El SDK de Firebase no se ha cargado.');
                }
                firebase.initializeApp(firebaseConfig);
                
                database = firebase.database();
                auth = firebase.auth();
                activeSessionsRef = database.ref('activeSessions');
                connectedRef = database.ref('.info/connected');
                queueRef = database.ref(QUEUE_PATH);
                activeUserRef = database.ref(ACTIVE_USER_PATH);
                
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                setupConnectionListener();
                setupLoginUI();
                setupQueueSystem();
                setupGlobalTimerListener();
                requestNotificationPermission();
            } catch (error) {
                console.error('Error al inicializar la aplicaci√≥n:', error);
                showErrorScreen(`Error al inicializar: ${error.message}`);
            }
        }

        // =================================================================================
        // L√ìGICA DE CONEXI√ìN
        // =================================================================================
        function setupConnectionListener() {
            try {
                connectedRef.on('value', (snap) => {
                    isConnected = snap.val() === true;
                    updateConnectionStatus();
                    if (!isConnected) {
                        showNotification('üî¥ Conexi√≥n perdida. Intentando reconectar...', 'warning');
                    } else {
                        showNotification('üü¢ Conexi√≥n restablecida.', 'success');
                    }
                }, (error) => {
                    console.error('Error en el listener de conexi√≥n:', error);
                    showNotification('Error en la conexi√≥n: ' + error.message, 'error');
                });
            } catch (error) {
                console.error('Error configurando el listener de conexi√≥n:', error);
                showNotification('Error configurando conexi√≥n: ' + error.message, 'error');
            }
        }

        // =================================================================================
        // L√ìGICA DE SESI√ìN (LOGIN, LOGOUT, HEARTBEAT)
        // =================================================================================
        function setupLoginUI() {
            try {
                const loginModal = document.getElementById('loginModal');
                loginModal.style.display = 'flex';
                document.getElementById('loginButton').onclick = handleLoginClick;
                document.getElementById('forgotPasswordLink').onclick = handleForgotPassword;
                document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLoginClick();
                });
            } catch (error) {
                console.error('Error configurando UI de login:', error);
                showErrorScreen('Error en la interfaz de login: ' + error.message);
            }
        }

        async function handleLoginClick() {
            if (isLoggingIn) return;
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) return showError('Ingresa correo y contrase√±a.');

            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            isLoggingIn = true;
            loginButton.disabled = true;
            loginButtonText.innerHTML = '<span class="loading-spinner"></span> Verificando...';
            showError(null);

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                const sessionRef = activeSessionsRef.child(user.uid);
                const sessionSnapshot = await sessionRef.once('value');
                if (sessionSnapshot.exists()) {
                    await auth.signOut();
                    throw new Error(`El usuario ${email} ya tiene una sesi√≥n activa.`);
                }

                sessionId = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                await sessionRef.set({
                    userId: user.uid,
                    email: user.email,
                    sessionId: sessionId,
                    loginTime: firebase.database.ServerValue.TIMESTAMP,
                    lastHeartbeatTime: firebase.database.ServerValue.TIMESTAMP
                });
                await sessionRef.onDisconnect().remove();

                currentUser = user;
                sessionStartTime = Date.now();
                document.getElementById('userName').textContent = currentUser.email;
                document.getElementById('sessionStart').textContent = new Date(sessionStartTime).toLocaleString('es-DO');
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';

                startHeartbeat();
                startSessionMonitoring();
                showNotification(`üëã ¬°Bienvenido/a, ${currentUser.email}!`, 'success');
            } catch (error) {
                console.error('Error durante el login:', error);
                showError(error.message);
            } finally {
                isLoggingIn = false;
                loginButton.disabled = false;
                loginButtonText.innerHTML = 'üöÄ Iniciar Sesi√≥n';
            }
        }

        async function logout() {
            if (!currentUser) return;
            try {
                await cleanupQueueOnLogout();
                await activeSessionsRef.child(currentUser.uid).remove();
                await auth.signOut();
                showNotification('Sesi√≥n cerrada.', 'success');
            } catch (error) {
                console.error('Error en logout:', error);
                showNotification(`Error al cerrar sesi√≥n: ${error.message}`, 'error');
            } finally {
                cleanupSessionState();
            }
        }

        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(async () => {
                if (currentUser && isConnected) {
                    try {
                        await activeSessionsRef.child(currentUser.uid).update({
                            lastHeartbeatTime: firebase.database.ServerValue.TIMESTAMP
                        });
                    } catch (error) {
                        console.error('Error en heartbeat:', error);
                        showNotification('Error en la conexi√≥n de heartbeat: ' + error.message, 'error');
                    }
                }
            }, HEARTBEAT_INTERVAL);
        }

        function startSessionMonitoring() {
            if (sessionCheckInterval) clearInterval(sessionCheckInterval);
            sessionCheckInterval = setInterval(async () => {
                if (!currentUser || !isConnected) return;
                try {
                    const sessionSnapshot = await activeSessionsRef.child(currentUser.uid).once('value');
                    if (!sessionSnapshot.exists() || sessionSnapshot.val().sessionId !== sessionId) {
                        showNotification('Sesi√≥n cerrada desde otro dispositivo.', 'error');
                        await logout();
                    }
                } catch (error) {
                    console.error('Error en monitoreo de sesi√≥n:', error);
                    showNotification('Error en monitoreo de sesi√≥n: ' + error.message, 'error');
                }
            }, SESSION_CHECK_INTERVAL);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        function stopSessionMonitoring() {
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
                sessionCheckInterval = null;
            }
        }

        function cleanupSessionState() {
            try {
                stopAllTimers();
                stopHeartbeat();
                stopSessionMonitoring();
                if (currentUser) activeSessionsRef.child(currentUser.uid).off();
                activeUserRef.off();
                queueRef.off();
                currentUser = null;
                sessionId = null;
                sessionStartTime = null;
                isLoggingIn = false;
                hasBeenNotified = false;
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('emailInput').value = '';
                document.getElementById('passwordInput').value = '';
                showError(null);
                showWarning(null);
            } catch (error) {
                console.error('Error limpiando estado de sesi√≥n:', error);
                showNotification('Error al limpiar estado: ' + error.message, 'error');
            }
        }

        function handleForgotPassword(e) {
            e.preventDefault();
            showWarning('Por favor, contacta al administrador para restablecer tu contrase√±a.');
        }

        // =================================================================================
        // L√ìGICA DE COLA Y TURNOS
        // =================================================================================
        function setupQueueSystem() {
            try {
                document.getElementById('joinQueueBtn').onclick = joinQueue;
                setupQueueListeners();
            } catch (error) {
                console.error('Error configurando sistema de cola:', error);
                showNotification('Error en sistema de cola: ' + error.message, 'error');
            }
        }

        async function joinQueue() {
            if (!isConnected || !currentUser) {
                showNotification('No est√°s conectado o autenticado.', 'error');
                return;
            }
            try {
                console.log('Intentando unirse a la cola para usuario:', currentUser.uid);
                const activeUserSnap = await activeUserRef.once('value');
                if (activeUserSnap.exists() && activeUserSnap.val().userId === currentUser.uid) {
                    showNotification('Ya tienes un turno activo.', 'warning');
                    return;
                }
                const queueSnap = await queueRef.orderByChild('userId').equalTo(currentUser.uid).once('value');
                if (queueSnap.exists()) {
                    const updates = {};
                    queueSnap.forEach(child => {
                        updates[child.key] = null;
                    });
                    await queueRef.update(updates);
                    console.log('Entradas antiguas de la cola eliminadas para usuario:', currentUser.uid);
                    showNotification('Se eliminaron entradas antiguas de la cola.', 'warning');
                }
                
                const newEntryRef = queueRef.push();
                await newEntryRef.set({
                    key: newEntryRef.key,
                    userId: currentUser.uid,
                    email: currentUser.email,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                });
                console.log('Usuario a√±adido a la cola:', currentUser.uid, 'con clave:', newEntryRef.key);

                showNotification('Te uniste a la cola.', 'success');
                if (!activeUserSnap.exists()) {
                    await activateNextInQueue();
                }
            } catch (error) {
                console.error('Error al unirse a la cola:', error);
                showNotification(`Error al unirse a la cola: ${error.message}`, 'error');
            }
        }

        async function leaveQueue(queueKey) {
            try {
                console.log('Intentando salir de la cola, clave:', queueKey);
                await queueRef.child(queueKey).remove();
                showNotification('Has salido de la cola.', 'success');
            } catch (error) {
                console.error('Error al salir de la cola:', error);
                showNotification(`Error al salir de la cola: ${error.message}`, 'error');
            }
        }

        async function activateNextInQueue() {
            try {
                console.log('Activando siguiente usuario en la cola');
                const activeUserSnap = await activeUserRef.once('value');
                if (activeUserSnap.exists()) {
                    console.log('Ya hay un usuario activo:', activeUserSnap.val().userId);
                    return;
                }

                const queueSnap = await queueRef.orderByChild('joinedAt').limitToFirst(1).once('value');
                if (!queueSnap.exists()) {
                    console.log('No hay usuarios en la cola');
                    return;
                }

                const queueData = queueSnap.val();
                const key = Object.keys(queueData)[0];
                const userToActivate = queueData[key];
                
                await activeUserRef.set({
                    userId: userToActivate.userId,
                    email: userToActivate.email,
                    startTime: firebase.database.ServerValue.TIMESTAMP,
                    remainingTime: TURN_TIME,
                    isPaused: false
                });
                await queueRef.child(key).remove();
                console.log('Usuario activado:', userToActivate.userId);
            } catch (error) {
                console.error('Error al activar el siguiente en la cola:', error);
                showNotification('Error al activar el siguiente usuario: ' + error.message, 'error');
            }
        }

        async function cleanupQueueOnLogout() {
            if (!currentUser) return;
            try {
                console.log('Limpiando datos de cola para usuario:', currentUser.uid);
                const queueSnap = await queueRef.orderByChild('userId').equalTo(currentUser.uid).once('value');
                if (queueSnap.exists()) {
                    const updates = {};
                    queueSnap.forEach(child => {
                        updates[child.key] = null;
                    });
                    await queueRef.update(updates);
                    console.log('Entradas de cola eliminadas para usuario:', currentUser.uid);
                }
                const activeUserSnap = await activeUserRef.once('value');
                if (activeUserSnap.exists() && activeUserSnap.val().userId === currentUser.uid) {
                    await activeUserRef.remove();
                    console.log('Usuario activo eliminado:', currentUser.uid);
                    await activateNextInQueue();
                }
            } catch (error) {
                console.error('Error limpiando cola:', error);
                showNotification(`Error al limpiar datos: ${error.message}`, 'error');
            }
        }

        // =================================================================================
        // TEMPORIZADOR DE TURNO SINCRONIZADO
        // =================================================================================
        function setupQueueListeners() {
            try {
                activeUserRef.on('value', (snap) => {
                    try {
                        const data = snap.val();
                        renderActiveUser(data);
                        if (data && data.userId === currentUser?.uid && !hasBeenNotified) {
                            showNotification('¬°Es tu turno!', 'success');
                            showSystemNotification('¬°Es tu turno! Regresa al sistema.');
                            hasBeenNotified = true;
                        } else if (!data || data.userId !== currentUser?.uid) {
                            hasBeenNotified = false;
                        }
                    } catch (error) {
                        console.error('Error en listener de usuario activo:', error);
                        showNotification('Error en datos de usuario activo: ' + error.message, 'error');
                    }
                }, (error) => {
                    console.error('Error en listener de activeUserRef:', error);
                    showNotification('Error en listener de usuario activo: ' + error.message, 'error');
                });
                queueRef.on('value', (snap) => {
                    try {
                        renderQueue(snap.val());
                    } catch (error) {
                        console.error('Error en listener de cola:', error);
                        showNotification('Error en datos de cola: ' + error.message, 'error');
                    }
                }, (error) => {
                    console.error('Error en listener de queueRef:', error);
                    showNotification('Error en listener de cola: ' + error.message, 'error');
                });
            } catch (error) {
                console.error('Error configurando listeners de cola:', error);
                showNotification('Error configurando sistema de cola: ' + error.message, 'error');
            }
        }

        function setupGlobalTimerListener() {
            try {
                activeUserRef.on('value', (snap) => {
                    try {
                        stopAllTimers();
                        const data = snap.val();
                        if (!data) {
                            updateTimerDisplayUI(TURN_TIME);
                            renderActiveUser(null);
                            return;
                        }
                        updateTimerDisplayUI(data.remainingTime || TURN_TIME);
                        if (!data.isPaused) {
                            startClientTimer(data);
                            if (data.userId === currentUser?.uid) {
                                startAuthoritativeSync(data.remainingTime || TURN_TIME);
                            }
                        }
                    } catch (error) {
                        console.error('Error en listener de temporizador:', error);
                        showNotification('Error en temporizador: ' + error.message, 'error');
                    }
                }, (error) => {
                    console.error('Error en listener de temporizador global:', error);
                    showNotification('Error en listener de temporizador: ' + error.message, 'error');
                });
            } catch (error) {
                console.error('Error configurando listener de temporizador:', error);
                showNotification('Error configurando temporizador: ' + error.message, 'error');
            }
        }

        function startClientTimer(activeUserData) {
            try {
                let remaining = activeUserData.remainingTime || TURN_TIME;
                updateTimerDisplayUI(remaining);
                globalTimerInterval = setInterval(() => {
                    remaining--;
                    if (remaining < 0) {
                        stopAllTimers();
                        if (activeUserData.userId === currentUser?.uid) {
                            activeUserRef.remove().then(() => {
                                console.log('Turno finalizado para usuario:', activeUserData.userId);
                                activateNextInQueue();
                            }).catch(e => {
                                console.error('Error al finalizar turno:', e);
                                showNotification('Error al finalizar turno: ' + e.message, 'error');
                            });
                        }
                    } else {
                        updateTimerDisplayUI(remaining);
                    }
                }, 1000);
            } catch (error) {
                console.error('Error iniciando temporizador del cliente:', error);
                showNotification('Error en temporizador del cliente: ' + error.message, 'error');
            }
        }

        function startAuthoritativeSync(initialTime) {
            try {
                let remaining = initialTime || TURN_TIME;
                syncInterval = setInterval(async () => {
                    try {
                        remaining -= SYNC_INTERVAL_SECONDS;
                        if (remaining < 0) {
                            stopAllTimers();
                            await activeUserRef.remove();
                            console.log('Turno finalizado por sincronizaci√≥n autoritativa');
                            await activateNextInQueue();
                        } else {
                            await activeUserRef.update({ remainingTime: remaining });
                            console.log('Tiempo restante actualizado:', remaining);
                        }
                    } catch (error) {
                        console.error('Error en sincronizaci√≥n autoritativa:', error);
                        showNotification('Error al sincronizar tiempo: ' + error.message, 'error');
                    }
                }, SYNC_INTERVAL_SECONDS * 1000);
            } catch (error) {
                console.error('Error iniciando sincronizaci√≥n autoritativa:', error);
                showNotification('Error en sincronizaci√≥n de tiempo: ' + error.message, 'error');
            }
        }

        function stopAllTimers() {
            try {
                if (globalTimerInterval) clearInterval(globalTimerInterval);
                if (syncInterval) clearInterval(syncInterval);
                globalTimerInterval = null;
                syncInterval = null;
            } catch (error) {
                console.error('Error deteniendo temporizadores:', error);
                showNotification('Error deteniendo temporizadores: ' + error.message, 'error');
            }
        }

        function pauseTimer() {
            if (currentUser) {
                try {
                    activeUserRef.update({ isPaused: true }).catch(e => {
                        console.error('Error al pausar el temporizador:', e);
                        showNotification('Error al pausar el temporizador: ' + e.message, 'error');
                    });
                } catch (error) {
                    console.error('Error en pauseTimer:', error);
                    showNotification('Error al pausar: ' + error.message, 'error');
                }
            }
        }

        function resumeTimer() {
            if (currentUser) {
                try {
                    activeUserRef.update({ isPaused: false }).catch(e => {
                        console.error('Error al reanudar el temporizador:', e);
                        showNotification('Error al reanudar el temporizador: ' + e.message, 'error');
                    });
                } catch (error) {
                    console.error('Error en resumeTimer:', error);
                    showNotification('Error al reanudar: ' + error.message, 'error');
                }
            }
        }

        // =================================================================================
        // RENDERIZADO Y FUNCIONES DE UTILIDAD
        // =================================================================================
        function renderActiveUser(data) {
            try {
                const activeUserInfo = document.getElementById('activeUserInfo');
                const timerControls = document.getElementById('timerControls');
                if (!data) {
                    activeUserInfo.innerHTML = 'Nadie activo';
                    timerControls.innerHTML = '';
                    updateTimerDisplayUI(TURN_TIME);
                    return;
                }
                activeUserInfo.innerHTML = `<b>${data.email}</b>`;
                if (data.userId === currentUser?.uid) {
                    timerControls.innerHTML = `<button id="pauseTimerBtn" class="timer-btn" ${data.isPaused ? 'disabled' : ''}><span>‚è∏Ô∏è</span> Pausar</button> <button id="resumeTimerBtn" class="timer-btn" ${!data.isPaused ? 'disabled' : ''}><span>‚ñ∂Ô∏è</span> Reanudar</button>`;
                    const pauseBtn = document.getElementById('pauseTimerBtn');
                    const resumeBtn = document.getElementById('resumeTimerBtn');
                    if (pauseBtn) pauseBtn.onclick = pauseTimer;
                    if (resumeBtn) resumeBtn.onclick = resumeTimer;
                } else {
                    timerControls.innerHTML = '';
                }
            } catch (error) {
                console.error('Error renderizando usuario activo:', error);
                showNotification('Error al mostrar usuario activo: ' + error.message, 'error');
            }
        }

        function renderQueue(queueData) {
            try {
                const queueListBody = document.querySelector('#queueListBody');
                queueListBody.innerHTML = '';
                if (!queueData) {
                    queueListBody.innerHTML = '<tr><td colspan="5">No hay usuarios en espera</td></tr>';
                    return;
                }
                const sortedQueue = Object.entries(queueData).sort(([, a], [, b]) => a.joinedAt - b.joinedAt);
                if (sortedQueue.length === 0) {
                    queueListBody.innerHTML = '<tr><td colspan="5">No hay usuarios en espera</td></tr>';
                    return;
                }
                sortedQueue.forEach(([key, q]) => {
                    const tr = document.createElement('tr');
                    if (q.userId === currentUser?.uid) tr.classList.add('current-user');
                    tr.innerHTML = `<td>${sortedQueue.indexOf([key, q]) + 1}</td> <td>${q.email}</td> <td>${new Date(q.joinedAt).toLocaleTimeString('es-DO')}</td> <td>En espera</td> <td>${q.userId === currentUser?.uid ? `<button class="leave-queue-btn" onclick="leaveQueue('${q.key}')">üöó Salir</button>` : ''}</td>`;
                    queueListBody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error renderizando cola:', error);
                showNotification('Error al mostrar cola: ' + error.message, 'error');
            }
        }

        function updateTimerDisplayUI(seconds) {
            try {
                const timerText = document.getElementById('timerText');
                const timerProgress = document.getElementById('timerProgress');
                const remaining = Math.max(0, seconds);
                timerText.textContent = `${Math.floor(remaining / 60).toString().padStart(2, '0')}:${(remaining % 60).toString().padStart(2, '0')}`;
                timerProgress.style.strokeDashoffset = 408.4 * (1 - (remaining / TURN_TIME));
            } catch (error) {
                console.error('Error actualizando UI del temporizador:', error);
                showNotification('Error en UI del temporizador: ' + error.message, 'error');
            }
        }

        function updateConnectionStatus() {
            try {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.textContent = isConnected ? 'üü¢ Conectado' : 'üî¥ Desconectado';
                statusElement.className = `connection-status ${isConnected ? 'connected' : 'disconnected'}`;
            } catch (error) {
                console.error('Error actualizando estado de conexi√≥n:', error);
                showNotification('Error en estado de conexi√≥n: ' + error.message, 'error');
            }
        }

        function updateCurrentTime() {
            try {
                document.getElementById('currentTime').textContent = new Date().toLocaleString('es-DO', { dateStyle: 'full', timeStyle: 'medium' });
            } catch (error) {
                console.error('Error actualizando hora actual:', error);
                showNotification('Error actualizando hora: ' + error.message, 'error');
            }
        }

        function showError(message) {
            try {
                const el = document.getElementById('userError');
                el.style.display = message ? 'block' : 'none';
                el.textContent = message;
            } catch (error) {
                console.error('Error mostrando mensaje de error:', error);
            }
        }

        function showWarning(message) {
            try {
                const el = document.getElementById('userWarning');
                el.style.display = message ? 'block' : 'none';
                el.textContent = message;
            } catch (error) {
                console.error('Error mostrando mensaje de advertencia:', error);
            }
        }

        function showNotification(message, type = 'success') {
            try {
                const el = document.getElementById('notification');
                el.textContent = message;
                el.className = `notification ${type} show`;
                setTimeout(() => el.classList.remove('show'), 4000);
            } catch (error) {
                console.error('Error mostrando notificaci√≥n:', error);
            }
        }

        function requestNotificationPermission() {
            try {
                if ("Notification" in window && Notification.permission !== 'granted') {
                    Notification.requestPermission();
                }
            } catch (error) {
                console.error('Error solicitando permiso de notificaci√≥n:', error);
            }
        }

        function showSystemNotification(message) {
            try {
                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification("Sistema de Turnos", { body: message });
                }
            } catch (error) {
                console.error('Error mostrando notificaci√≥n del sistema:', error);
            }
        }

        function showErrorScreen(message) {
            try {
                document.body.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: #f4f4f4; color: #333; text-align: center;"><div style="background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);"><h2>üÜò Error Cr√≠tico</h2><p style="margin: 20px 0;">${message}</p><button style="background: #667eea; color: white; padding: 12px 25px; border-radius: 5px; cursor: pointer;" onclick="window.location.reload()">üîÑ Recargar</button></div></div>`;
            } catch (error) {
                console.error('Error mostrando pantalla de error:', error);
            }
        }
    </script>
</body>
</html>
